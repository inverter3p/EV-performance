<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>PID Control Simulator</title>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap"
      rel="stylesheet"
    />
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
    <style>
      /* MODIFIED: Updated color palette to match the target image's theme */
      :root {
        --bg-color: #fdfaf4;
        --card-bg-color: #ffffff;
        --primary-text-color: #111111;
        --secondary-text-color: #555555;
        --accent-color: #111111;
        --tab-color: #147aaa;
        --divider-color: #eeeeee;
        --input-bg-color: #f5f5f5;
        --error-color: #d32f2f;
        --warning-color: #f57c00;
        --success-color: #4caf50;
      }

      body {
        font-family: 'Inter', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto,
          "Helvetica Neue", Arial, sans-serif;
        margin: 0;
        background-color: var(--bg-color);
        color: var(--primary-text-color);
        display: flex;
        justify-content: center;
        padding: 1rem;
      }
      .main-container {
        display: flex;
        flex-wrap: wrap;
        gap: 1.5rem;
        width: 100%;
        max-width: 1300px;
      }
      .controls-panel {
        flex: 1;
        min-width: 320px;
        display: flex;
        flex-direction: column;
        gap: 1.5rem;
      }
      .plot-panel {
        flex: 2.5;
        min-width: 500px;
      }
      .card {
        background-color: var(--card-bg-color);
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        padding: 1.5rem;
      }
      .card h2 {
        margin-top: 0;
        margin-bottom: 1.5rem;
        font-size: 1.25rem;
        color: var(--primary-text-color);
        border-bottom: 1px solid var(--divider-color);
        padding-bottom: 0.75rem;
        display: flex;
        align-items: center;
        justify-content: space-between;
      }
      .form-group {
        margin-bottom: 1rem;
      }
      .form-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 1rem;
      }
      .form-group label {
        display: block;
        font-weight: 500;
        margin-bottom: 0.5rem;
        color: var(--secondary-text-color);
        font-size: 0.9rem;
      }
      .form-group input[type="text"],
      .form-group input[type="number"],
      .form-group input[type="checkbox"] {
        width: 100%;
        padding: 0.75rem;
        border: 1px solid var(--divider-color);
        border-radius: 4px;
        background-color: var(--input-bg-color);
        box-sizing: border-box;
        font-size: 1rem;
        transition: border-color 0.2s;
      }
      .form-group input:focus {
        outline: none;
        border-color: var(--accent-color);
      }
      .form-group input.error {
        border-color: var(--error-color);
      }

      .status-message {
        font-size: 0.85rem;
        min-height: 1.2em;
        margin-top: -0.5rem;
        margin-bottom: 1rem;
        font-weight: 500;
      }
      .status-message.error {
        color: var(--error-color);
      }
      .status-message.warning {
        color: var(--warning-color);
      }
      .status-message.diverged {
        color: var(--error-color);
        font-weight: 700;
        font-size: 0.9rem;
      }

      .radio-group {
        display: flex;
        gap: 1rem;
        margin-top: 0.5rem;
      }
      .radio-group label {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        cursor: pointer;
      }
      .slider-group {
        display: grid;
        grid-template-columns: 1fr auto;
        align-items: center;
        gap: 1rem;
      }
      .slider-group input[type="range"] {
        -webkit-appearance: none;
        appearance: none;
        width: 100%;
        height: 8px;
        background: var(--input-bg-color);
        outline: none;
        border-radius: 4px;
      }
      .slider-group input[type="range"]::-webkit-slider-thumb {
        -webkit-appearance: none;
        appearance: none;
        width: 20px;
        height: 20px;
        background: var(--accent-color);
        cursor: pointer;
        border-radius: 50%;
        border: 2px solid var(--card-bg-color);
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.2);
      }
      #controller-options {
        transition: opacity 0.3s ease-in-out, max-height 0.3s ease-in-out, margin-bottom 0.3s ease-in-out;
        overflow: hidden;
        max-height: 800px; /* Adjust if content is taller */
        opacity: 1;
        margin-bottom: 1rem;
      }
      #controller-options.hidden {
        max-height: 0;
        opacity: 0;
        margin-bottom: 0;
        /* Required to prevent interaction when hidden */
        pointer-events: none;
        user-select: none;
      }

      #calculate-btn {
        width: 100%;
        padding: 0.85rem;
        font-size: 1rem;
        font-weight: 500;
        color: var(--bg-color); /* MODIFIED: Use new bg color for text */
        background-color: var(--accent-color);
        border: none;
        border-radius: 4px;
        cursor: pointer;
        transition: background-color 0.5s, font-weight 0.2s;
        margin-top: 0.5rem;
      }
      #calculate-btn:hover {
        background-color: #444444; /* Darker black for hover */
      }

      @keyframes pulse-glow {
        /* MODIFIED: Changed pulse to green to stand out on the new theme */
        0% {
          box-shadow: 0 0 0 0 rgba(76, 175, 80, 0.7);
        }
        70% {
          box-shadow: 0 0 4px 8px rgba(76, 175, 80, 0);
        }
        100% {
          box-shadow: 0 0 0 0 rgba(76, 175, 80, 0);
        }
      }
      #calculate-btn.needs-recalc {
        background-color: #4caf50; /* Keep success color for visibility */
        font-weight: 700;
        animation: pulse-glow 2s infinite;
      }

      .plot-tabs {
        display: flex;
        border-bottom: 1px solid var(--divider-color);
        margin-bottom: 1.5rem;
      }
      .tab-btn {
        padding: 0.75rem 1rem;
        border: none;
        background-color: transparent;
        cursor: pointer;
        font-size: 1rem;
        color: var(--secondary-text-color);
        border-bottom: 2px solid transparent;
      }
      .tab-btn.active {
        color: var(--accent-color);
        border-bottom-color: #4caf50;
        font-weight: 550;
      }
      .plot-container {
        display: none;
      }
      .plot-container.active {
        display: block;
      }

      .checkbox-group {
        font-size: 1rem;
        align-items: center;
        gap: 0.5rem;
        margin-bottom: 0.5rem;
      }
      .checkbox-group label {
        font-weight: 500;
        margin-bottom: 0.5rem;
        color: var(--secondary-text-color);
        font-size: 0.9rem;
      }
      .checkbox-group input[type="checkbox"] {
        padding: 0.75rem;
        border: 1px solid var(--divider-color);
        border-radius: 4px;
        background-color: var(--input-bg-color);
        box-sizing: border-box;
        font-size: 1rem;
        transition: border-color 0.2s;
      }
      #advanced-pid-options {
        padding-top: 1rem;
        border-top: 1px solid var(--divider-color);
        margin-top: 1rem;
        display: none;
      }

      .metrics-display {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
        gap: 1rem;
        margin-top: 1rem;
        text-align: center;
      }
      .metric {
        background-color: var(--input-bg-color); /* Use input color for contrast */
        padding: 0.5rem;
        border-radius: 4px;
      }
      .metric-label {
        font-size: 0.8rem;
        color: var(--secondary-text-color);
        display: block;
      }
      .metric-value {
        font-size: 1.1rem;
        font-weight: 550;
        color: var(--tab-color);
      }

      /* Help Modal Styles */
      .help-button {
        background: none;
        border: 2.5px solid var(--tab-color);
        color: var(--tab-color);
        border-radius: 50%;
        width: 24px;
        height: 24px;
        font-size: 14px;
        font-weight: bold;
        cursor: pointer;
        transition: all 0.2s;
        flex-shrink: 0;
      }
      .help-button:hover {
        background-color: var(--input-bg-color);
        border-color: var(--accent-color);
        color: var(--accent-color);
      }

      .modal-overlay {
        position: fixed;
        z-index: 1000;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        overflow: auto;
        background-color: rgba(0, 0, 0, 0.6);
        display: flex;
        justify-content: center;
        align-items: center;
        opacity: 0;
        visibility: hidden;
        transition: opacity 0.3s, visibility 0s 0.3s;
      }
      .modal-overlay.visible {
        opacity: 1;
        visibility: visible;
        transition: opacity 0.3s;
      }
      .modal-content {
        background-color: #ffffff; /* Modal content should be white for readability */
        padding: 2rem 2.5rem;
        border-radius: 8px;
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
        max-width: 600px;
        width: 90%;
        position: relative;
        transform: scale(0.95);
        transition: transform 0.3s;
      }
      .modal-overlay.visible .modal-content {
        transform: scale(1);
      }
      .modal-content h3 {
        margin-top: 0;
        font-size: 1.5rem;
        color: var(--tab-color);
        border-bottom: 1px solid var(--divider-color);
        padding-bottom: 1rem;
        margin-bottom: 1.5rem;
      }
      .modal-content p {
        line-height: 1.6;
        margin-bottom: 1rem;
      }

      .modal-content strong {
        line-height: 1.6;
        margin-bottom: 1rem;
        color: var(--tab-color);
      }
      .modal-content code {
        background-color: var(--input-bg-color);
        padding: 0.2em 0.4em;
        border-radius: 3px;
        font-family: "SFMono-Regular", Consolas, "Liberation Mono", Menlo,
          Courier, monospace;
      }
      .modal-content hr {
        border: 0;
        height: 1px;
        background-color: var(--divider-color);
        margin: 1.5rem 0;
      }
      .modal-close {
        color: #aaa;
        position: absolute;
        top: 1rem;
        right: 1.5rem;
        font-size: 28px;
        font-weight: bold;
        cursor: pointer;
        line-height: 1;
      }
      .modal-close:hover,
      .modal-close:focus {
        color: var(--primary-text-color);
        text-decoration: none;
      }
    </style>
  </head>
  <body>
    <div class="main-container">
      <div class="controls-panel">
        <div class="card">
          <h2>System Configuration</h2>
          <p id="status-message" class="status-message"></p>
          <div class="form-group">
            <label for="plant-num">Plant Numerator (Max order 5)</label>
            <input type="text" id="plant-num" value="[1]" />
          </div>
          <div class="form-group">
            <label for="plant-den">Plant Denominator (Max order 5)</label>
            <input type="text" id="plant-den" value="[1, 10, 20]" />
          </div>
          <div class="form-grid">
            <div class="form-group">
              <label for="sim-time">Simulation Time (s)</label>
              <input type="number" id="sim-time" value="10" min="1" step="1" />
            </div>
            <div class="form-group">
              <label for="sim-dt">Time Step (dt)</label>
              <input
                type="number"
                id="sim-dt"
                value="0.01"
                min="0.0001"
                step="0.0001"
              />
            </div>
          </div>
          <button id="calculate-btn">Calculate & Plot</button>
        </div>
        <div class="card">
          <h2>
            <span>Control Setup</span>
            <button id="help-btn" class="help-button">?</button>
          </h2>
          <div class="form-group">
            <label>Loop Type</label>
            <div class="radio-group">
              <label
                ><input type="radio" name="loop-type" value="open" checked/> Open
                Loop</label
              >
              <label
                ><input type="radio" name="loop-type" value="closed"  />
                Closed Loop</label
              >
            </div>
          </div>
          <div id="controller-options">
            <div class="form-group">
              <label for="setpoint-input">Setpoint</label
              ><input
                type="number"
                id="setpoint-input"
                value="1.0"
                step="0.1"
              />
            </div>
            <div class="form-group">
              <label>Controller Type</label>
              <div class="radio-group">
                <label
                  ><input type="radio" name="controller-type" value="P" />
                  P</label
                ><label
                  ><input type="radio" name="controller-type" value="PI" />
                  PI</label
                ><label
                  ><input
                    type="radio"
                    name="controller-type"
                    value="PID"
                    checked
                  />
                  PID</label
                >
              </div>
            </div>
            <div id="pid-gains">
              <div class="form-group" id="kp-group">
                <label for="kp">Proportional Gain (Kp)</label>
                <div class="slider-group">
                  <input
                    type="range"
                    id="kp"
                    min="0"
                    max="100"
                    step="0.5"
                    value="30"
                  /><span id="kp-value">30</span>
                </div>
              </div>
              <div class="form-group" id="ki-group">
                <label for="ki">Integral Gain (Ki)</label>
                <div class="slider-group">
                  <input
                    type="range"
                    id="ki"
                    min="0"
                    max="100"
                    step="0.5"
                    value="70"
                  /><span id="ki-value">70</span>
                </div>
              </div>
              <div class="form-group" id="kd-group">
                <label for="kd">Derivative Gain (Kd)</label>
                <div class="slider-group">
                  <input
                    type="range"
                    id="kd"
                    min="0"
                    max="10"
                    step="0.1"
                    value="1"
                  /><span id="kd-value">1</span>
                </div>
              </div>
            </div>
            <div class="checkbox-group">
              <input type="checkbox" id="show-advanced-pid" /><label
                for="show-advanced-pid"
                >  Show Advanced Options</label
              >
            </div>
            <div id="advanced-pid-options">
              <div class="checkbox-group">
                <input type="checkbox" id="enable-anti-windup" />
                <label for="enable-anti-windup">  Enable Anti-Windup</label>
              </div>
              <div class="form-grid">
                <div class="form-group">
                  <label for="sat-max">Max Output</label
                  ><input type="number" id="sat-max" value="100" />
                </div>
                <div class="form-group">
                  <label for="sat-min">Min Output</label
                  ><input type="number" id="sat-min" value="-100" />
                </div>
              </div>
              <div class="checkbox-group">
                <input type="checkbox" id="enable-deriv-filter" />
                <label for="enable-deriv-filter"
                  >  Enable Derivative Filter</label
                >
              </div>
              <div class="form-group">
                <label for="deriv-n">Filter Coefficient (N)</label
                ><input type="number" id="deriv-n" value="10" min="1" />
              </div>
            </div>
          </div>
        </div>
        <div class="card">
          <h2>Bode Plot Setup</h2>
          <div class="form-grid">
            <div class="form-group">
              <label for="bode-start-freq">Start Freq (rad/s)</label
              ><input type="number" id="bode-start-freq" value="0.01" />
            </div>
            <div class="form-group">
              <label for="bode-end-freq">End Freq (rad/s)</label
              ><input type="number" id="bode-end-freq" value="1000" />
            </div>
          </div>
        </div>
      </div>
      <div class="plot-panel">
        <div class="card">
          <div class="plot-tabs">
            <button
              class="tab-btn active"
              data-target="step-response-container"
            >
              Step Response
            </button>
            <button class="tab-btn" data-target="bode-plot-container">
              Bode Plot
            </button>
          </div>
          <div id="step-response-container" class="plot-container active">
            <canvas id="step-response-chart"></canvas>
            <div class="metrics-display" id="step-metrics">
              <div class="metric">
                <span class="metric-label">Overshoot</span
                ><span class="metric-value" id="overshoot-val">--</span>
              </div>
              <div class="metric">
                <span class="metric-label">Settling Time (±2%)</span
                ><span class="metric-value" id="settling-time-val">--</span>
              </div>
            </div>
          </div>
          <div id="bode-plot-container" class="plot-container">
            <canvas id="magnitude-chart"></canvas
            ><canvas id="phase-chart" style="margin-top: 1.5rem"></canvas>
            <div class="metrics-display" id="bode-metrics">
              <div class="metric">
                <span class="metric-label">Gain Margin</span
                ><span class="metric-value" id="gm-val">--</span>
              </div>
              <div class="metric">
                <span class="metric-label">Phase Margin</span
                ><span class="metric-value" id="pm-val">--</span>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Help Modal HTML -->
    <div id="help-modal" class="modal-overlay">
      <div class="modal-content">
        <span id="modal-close-btn" class="modal-close">&times;</span>
        <h3>Controller Help</h3>
        <p>
          <strong>PID Controller Transfer Function:</strong>
          <br />The ideal PID controller is defined in the Laplace domain as:
          <br /><code>C(s) = Kp + Ki/s + Kd*s</code>
        </p>
        <p>
          For practical implementation, a filter is added to the derivative term
          to reduce sensitivity to high-frequency noise.
          <br /><code>C(s) = Kp + Ki/s + (Kd * N * s) / (s + N)</code>
        </p>
        <hr />
        <p>
          <strong>Anti-Windup:</strong>
          <br />Integral windup occurs when the controller output is saturated
          (hits its maximum or minimum limit), but the integral term continues to
          accumulate error. This can lead to a large overshoot when the system
          finally starts to respond. Anti-windup prevents this by stopping or
          reducing integration when the output is saturated.
          <br /><strong>Guidance:</strong> Enable this if your controller output
          is likely to hit its limits. Set <em>Max/Min Output</em> to the
          physical limits of your actuator (e.g., motor voltage, valve
          position).
        </p>
        <hr />
        <p>
          <strong>Derivative Filter Coefficient (N):</strong>
          <br />This coefficient determines the aggressiveness of the derivative
          filter. It's related to the filter's cut-off frequency.
        </p>
        <ul>
          <li>
            A <strong>low N</strong> (e.g., 2-5) provides strong filtering, which
            is good for noisy systems but can make the derivative action
            sluggish.
          </li>
          <li>
            A <strong>high N</strong> (e.g., 10-20) provides weak filtering,
            resulting in a faster, more responsive derivative action that is
            more susceptible to noise.
          </li>
        </ul>
        <p>
          <strong>Guidance:</strong> Start with <strong>N = 10</strong>. If the
          controller output is very noisy or "chattering", decrease N. If the
          response is clean and you need faster derivative action, you can
          increase N.
        </p>
      </div>
    </div>

    <script>
      // UNMODIFIED SCRIPT: The plot styles are original
      document.addEventListener("DOMContentLoaded", () => {
        // --- ELEMENT SELECTORS ---
        const ui = {
          plantNum: document.getElementById("plant-num"),
          plantDen: document.getElementById("plant-den"),
          simTime: document.getElementById("sim-time"),
          simDt: document.getElementById("sim-dt"),
          calculateBtn: document.getElementById("calculate-btn"),
          statusMessage: document.getElementById("status-message"),
          controllerOptions: document.getElementById("controller-options"),
          setpoint: document.getElementById("setpoint-input"),
          kpSlider: document.getElementById("kp"),
          kiSlider: document.getElementById("ki"),
          kdSlider: document.getElementById("kd"),
          tabButtons: document.querySelectorAll(".tab-btn"),
          showAdvancedPid: document.getElementById("show-advanced-pid"),
          advancedPidOptions: document.getElementById("advanced-pid-options"),
          enableAntiWindup: document.getElementById("enable-anti-windup"),
          satMax: document.getElementById("sat-max"),
          satMin: document.getElementById("sat-min"),
          enableDerivFilter: document.getElementById("enable-deriv-filter"),
          derivN: document.getElementById("deriv-n"),
          bodeStartFreq: document.getElementById("bode-start-freq"),
          bodeEndFreq: document.getElementById("bode-end-freq"),
          overshootVal: document.getElementById("overshoot-val"),
          settlingTimeVal: document.getElementById("settling-time-val"),
          gmVal: document.getElementById("gm-val"),
          pmVal: document.getElementById("pm-val"),
          helpBtn: document.getElementById("help-btn"),
          helpModal: document.getElementById("help-modal"),
          modalCloseBtn: document.getElementById("modal-close-btn"),
          controllerTypeRadios: document.querySelectorAll(
            'input[name="controller-type"]'
          ),
          kpGroup: document.getElementById("kp-group"),
          kiGroup: document.getElementById("ki-group"),
          kdGroup: document.getElementById("kd-group"),
          loopTypeRadios: document.querySelectorAll('input[name="loop-type"]'),
        };

        // --- FORMATTING HELPERS ---
        function formatWithSIPrefix(val) {
          if (val === 0) return "0";
          const tiers = [
            { p: 1e12, s: "T" },
            { p: 1e9, s: "G" },
            { p: 1e6, s: "M" },
            { p: 1e3, s: "k" },
            { p: 1, s: "" },
            { p: 1e-3, s: "m" },
            { p: 1e-6, s: "µ" },
            { p: 1e-9, s: "n" },
          ];
          const tier = tiers.find((t) => Math.abs(val) >= t.p);
          if (tier) {
            const scaledNum = val / tier.p;
            if (scaledNum % 1 === 0) {
              return scaledNum.toString() + tier.s;
            } else {
              return scaledNum.toPrecision(3) + tier.s;
            }
          }
          return val.toExponential(0);
        }

        // --- CHART INITIALIZATION ---
        const charts = {};
        const createChart = (id, options) =>
          new Chart(document.getElementById(id).getContext("2d"), options);
        charts.step = createChart("step-response-chart", {
          type: "line",
          data: {
            datasets: [
              {
                label: "±2% Settling Band",
                data: [],
                borderColor: "rgba(76, 175, 80, 0.5)",
                backgroundColor: "rgba(76, 175, 80, 0.2)",
                borderWidth: 1,
                fill: 'origin',
                pointRadius: 0,
                order: 3,
              },
              {
                label: "Response",
                data: [],
                borderColor: "var(--accent-color)",
                borderWidth: 2,
                pointRadius: 0,
                tension: 0.1,
                order: 2,
              },
              {
                label: "Setpoint",
                data: [],
                borderColor: "var(--secondary-text-color)",
                borderWidth: 2,
                pointRadius: 0,
                borderDash: [3, 3],
                order: 1,
              },
              {
                label: "Overshoot",
                data: [],
                type: "scatter",
                borderColor: 'red',
                backgroundColor: "rgba(255, 50, 0, 0.2)",
                pointRadius: 5,
                pointHoverRadius: 7,
                order: 0,
              },
            ],
          },
          options: {
            responsive: true,
            scales: {
              x: {
                type: "linear",
                title: { display: true, text: "Time (s)" },
                beginAtZero: true,
              },
              y: { type: "linear", title: { display: true, text: "Output" } },
            },
            plugins: {
              legend: {
                display: true,
                labels: {
                  usePointStyle: true,
                  pointStyle: "line",
                },
              },
              title: {
                display: true,
                text: "System Response",
                font: { size: 16 },
              },
              tooltip: {
                filter: (item) => item.datasetIndex === 1,
                mode: "index",
                intersect: false,
              },
            },
            animation: { duration: 0 },
          },
        });
        const bodeOptions = (yLabel, title) => ({
          responsive: true,
          scales: {
            x: {
              type: "logarithmic",
              title: { display: true, text: "Frequency (rad/s)" },
              ticks: {
                callback: (val) =>
                  Math.log10(val) % 1 === 0 ? formatWithSIPrefix(val) : "",
              },
            },
            y: { title: { display: true, text: yLabel } },
          },
          plugins: {
            legend: { display: false },
            title: { display: true, text: title, font: { size: 16 } },
            tooltip: { mode: "nearest", intersect: false },
          },
          animation: { duration: 0 },
        });
        charts.mag = createChart("magnitude-chart", {
          type: "line",
          data: {
            datasets: [
              {
                label: "Magnitude",
                data: [],
                borderColor: '"var(--accent-color)"',
                borderWidth: 2,
                pointRadius: 0,
              },
              {
                label: "Gain Margin Line",
                data: [],
                borderColor: "rgba(255, 25, 0, 0.5)",
                borderDash: [3, 2],
              },
            ],
          },
          options: bodeOptions("Magnitude (dB)", "Bode Plot: Magnitude"),
        });
        charts.phase = createChart("phase-chart", {
          type: "line",
          data: {
            datasets: [
              {
                label: "Phase",
                data: [],
                borderColor: "var(--accent-color)",
                borderWidth: 2,
                pointRadius: 0,
              },
              {
                label: "Phase Margin Line",
                data: [],
                borderColor: "rgba(255, 25, 0, 0.5)",
                borderDash: [3, 2],
              },
            ],
          },
          options: bodeOptions("Phase (degrees)", "Bode Plot : Phase"),
        });

        // --- MATH & SIMULATION HELPERS ---
        const poly = {
          add: (p1, p2) => {
            const l1 = p1.length,
              l2 = p2.length,
              mL = Math.max(l1, l2),
              r = new Array(mL).fill(0);
            for (let i = 0; i < mL; i++) {
              const v1 = i < l1 ? p1[l1 - 1 - i] : 0;
              const v2 = i < l2 ? p2[l2 - 1 - i] : 0;
              r[mL - 1 - i] = v1 + v2;
            }
            return r;
          },
          multiply: (p1, p2) => {
            const l1 = p1.length,
              l2 = p2.length;
            if (l1 === 0 || l2 === 0) return [];
            const r = new Array(l1 + l2 - 1).fill(0);
            for (let i = 0; i < l1; i++) {
              for (let j = 0; j < l2; j++) {
                r[i + j] += p1[i] * p2[j];
              }
            }
            return r;
          },
        };
        class Complex {
          constructor(re = 0, im = 0) {
            this.re = re;
            this.im = im;
          }
          add(o) {
            return new Complex(this.re + o.re, this.im + o.im);
          }
          multiply(o) {
            return new Complex(
              this.re * o.re - this.im * o.im,
              this.re * o.im + this.im * o.re
            );
          }
          divide(o) {
            const d = o.re * o.re + o.im * o.im;
            return d === 0
              ? new Complex(Infinity, Infinity)
              : new Complex(
                  (this.re * o.re + this.im * o.im) / d,
                  (this.im * o.re - this.re * o.im) / d
                );
          }
          magnitude() {
            return Math.sqrt(this.re * this.re + this.im * this.im);
          }
          phase() {
            return Math.atan2(this.im, this.re);
          }
        }
        function evaluatePoly(p, s) {
          let r = new Complex(0, 0);
          for (let i = 0; i < p.length; i++)
            r = r.multiply(s).add(new Complex(p[i], 0));
          return r;
        }
        function logspace(start, stop, n) {
          const r = [],
            d = (stop - start) / (n - 1);
          for (let i = 0; i < n; i++) r.push(Math.pow(10, start + i * d));
          return r;
        }
        function tfToSS(num, den) {
          const norm = den[0] || 1;
          den = den.map((d) => d / norm);
          num = num.map((n) => n / norm);
          while (num.length < den.length) num.unshift(0);
          const n = den.length - 1;
          if (n < 1) return null;
          const A = Array(n)
              .fill(0)
              .map(() => Array(n).fill(0)),
            B = Array(n)
              .fill(0)
              .map(() => [0]),
            C = [Array(n).fill(0)];
          let D = [num[0]];
          for (let i = 0; i < n - 1; i++) A[i][i + 1] = 1;
          for (let i = 0; i < n; i++) A[n - 1][i] = -den[n - i];
          B[n - 1][0] = 1;
          for (let i = 0; i < n; i++)
            C[0][i] = num[n - i] - num[0] * den[n - i];
          return { A, B, C, D };
        }
        function calculateBodeData(num, den, freqs) {
          const mags = [],
            phases = [];
          let lastPhase = 0;
          freqs.forEach((w, idx) => {
            const s = new Complex(0, w);
            const numVal = evaluatePoly(num, s);
            const denVal = evaluatePoly(den, s);
            if (denVal.magnitude() === 0) {
              return;
            }
            const G = numVal.divide(denVal);
            mags.push({ x: w, y: 20 * Math.log10(G.magnitude()) });
            let phase = (G.phase() * 180) / Math.PI;
            if (idx > 0) {
              while (lastPhase - phase > 180) phase += 360;
              while (phase - lastPhase > 180) phase -= 360;
            }
            phases.push({ x: w, y: phase });
            lastPhase = phase;
          });
          return { mags, phases };
        }
        function simulateSystem(params) {
          const { ss, duration, dt, setpoint, controller } = params;
          const n = ss.A.length;
          let x = Array(n).fill(0);
          let integrator = 0,
            derivative = 0,
            lastError = 0,
            last_u = 0;
          const time = [],
            output = [];
          let diverged = false;
          const getPlantDerivatives = (state, u) => {
            const x_dot = Array(n).fill(0);
            for (let i = 0; i < n; i++) {
              for (let j = 0; j < n; j++) x_dot[i] += ss.A[i][j] * state[j];
              x_dot[i] += ss.B[i][0] * u;
            }
            return x_dot;
          };
          for (let t = 0; t <= duration; t += dt) {
            let y = ss.D[0] * last_u;
            for (let i = 0; i < n; i++) y += ss.C[0][i] * x[i];
            time.push(t);
            output.push(y);
            if (Math.abs(y) > 5 * Math.abs(setpoint) && setpoint !== 0) {
              diverged = true;
              break;
            }
            let u = setpoint;
            if (controller) {
              const error = setpoint - y;
              integrator += error * dt;
              const rawDerivative = (error - lastError) / dt;
              if (controller.derivFilter.enabled && controller.Kd > 0) {
                const Tf =
                  controller.Kd / (controller.Kp * controller.derivFilter.N);
                derivative = (Tf * derivative + dt * rawDerivative) / (Tf + dt);
              } else {
                derivative = rawDerivative;
              }
              lastError = error;
              u =
                controller.Kp * error +
                controller.Ki * integrator +
                controller.Kd * derivative;
              if (controller.antiWindup.enabled) {
                const u_saturated = Math.max(
                  controller.antiWindup.satMin,
                  Math.min(controller.antiWindup.satMax, u)
                );
                if (u !== u_saturated && controller.Ki !== 0)
                  integrator -= (u - u_saturated) / controller.Ki;
                u = u_saturated;
              }
            }
            const x_dot1 = getPlantDerivatives(x, u);
            const x_pred = x.map((v, i) => v + x_dot1[i] * dt);
            const x_dot2 = getPlantDerivatives(x_pred, u);
            x = x.map((v, i) => v + ((x_dot1[i] + x_dot2[i]) / 2) * dt);
            last_u = u;
          }
          return { time, output, diverged };
        }

        // --- ANALYSIS FUNCTIONS ---
        function analyzeStepResponse(time, data, setpoint) {
          if (data.length < 2 || setpoint === 0)
            return {
              overshoot: "--",
              settlingTime: "--",
              peakPoint: [],
              bands: [],
            };
          let peakValue = data[0],
            peakTime = time[0];
          for (let i = 1; i < data.length; i++) {
            if (data[i] > peakValue) {
              peakValue = data[i];
              peakTime = time[i];
            }
          }
          const overshoot = ((peakValue - setpoint) / setpoint) * 100;
          let settlingTime = "--";
          const upperBand = setpoint * 1.02,
            lowerBand = setpoint * 0.98;
          for (let i = data.length - 1; i >= 0; i--) {
            if (data[i] > upperBand || data[i] < lowerBand) {
              settlingTime =
                i < data.length - 1
                  ? time[i + 1].toFixed(2) + "s"
                  : "> " + time[time.length - 1].toFixed(2) + "s";
              break;
            }
            if (i === 0) settlingTime = time[0].toFixed(2) + "s";
          }
          return {
            overshoot: (overshoot > 0.1 ? overshoot.toFixed(1) : "0") + "%",
            settlingTime,
            peakPoint: overshoot > 0.1 ? [{ x: peakTime, y: peakValue }] : [],
            bands: [
              { x: time[0], y: lowerBand },
              { x: time[time.length - 1], y: lowerBand },
              { x: time[time.length - 1], y: upperBand },
              { x: time[0], y: upperBand },
            ],
          };
        }
        function analyzeBode(mags, phases) {
          let gm = Infinity,
            pm = Infinity,
            gmFreq = null,
            pmFreq = null,
            phaseAtGC = -180,
            magAtPC = 0;
          for (let i = 0; i < mags.length - 1; i++) {
            if (mags[i].y >= 0 && mags[i + 1].y < 0) {
              pmFreq = mags[i].x;
              phaseAtGC = phases[i].y || -180;
              pm = 180 + phaseAtGC;
              break;
            }
          }
          for (let i = 0; i < phases.length - 1; i++) {
            if (phases[i].y >= -180 && phases[i + 1].y < -180) {
              gmFreq = phases[i].x;
              magAtPC = mags[i].y || 0;
              gm = -magAtPC;
              break;
            }
          }
          return {
            gm: isFinite(gm) ? gm.toFixed(2) + " dB" : "Inf",
            pm: isFinite(pm) ? pm.toFixed(2) + "°" : "Inf",
            gmLine: gmFreq
              ? [
                  { x: gmFreq, y: magAtPC },
                  { x: gmFreq, y: 0 },
                ]
              : [],
            pmLine: pmFreq
              ? [
                  { x: pmFreq, y: phaseAtGC },
                  { x: pmFreq, y: -180 },
                ]
              : [],
          };
        }

        // --- MAIN PLOT FUNCTION ---
        function updatePlot(isInitialLoad = false) {
          ui.calculateBtn.classList.remove("needs-recalc");
          ui.statusMessage.textContent = "";
          ui.statusMessage.className = "status-message";
          [ui.plantNum, ui.plantDen].forEach((el) =>
            el.classList.remove("error")
          );

          let plantNum, plantDen;
          try {
            plantNum = JSON.parse(ui.plantNum.value);
            plantDen = JSON.parse(ui.plantDen.value);
            if (
              !Array.isArray(plantNum) ||
              !Array.isArray(plantDen) ||
              plantDen.length === 0
            )
              throw new Error("Invalid TF format");
            if (plantDen.length - 1 > 5)
              throw new Error("Plant order cannot exceed 5.");
          } catch (e) {
            ui.plantNum.classList.add("error");
            ui.plantDen.classList.add("error");
            ui.statusMessage.textContent = e.message;
            ui.statusMessage.classList.add("error");
            signalRecalculationNeeded();
            return;
          }

          const simTime = parseFloat(ui.simTime.value),
            dt = parseFloat(ui.simDt.value);
          const loopType = document.querySelector(
            'input[name="loop-type"]:checked'
          ).value;
          const setpoint =
            loopType === "closed" ? parseFloat(ui.setpoint.value) || 1.0 : 1.0;

          const ss = tfToSS(plantNum, plantDen);
          if (!ss) {
            ui.statusMessage.textContent = "Invalid plant state space.";
            ui.statusMessage.classList.add("error");
            return;
          }

          // --- Step Response ---
          let controller = null;
          if (loopType === "closed") {
            const ct = document.querySelector(
              'input[name="controller-type"]:checked'
            ).value;
            controller = {
              Kp: ["P", "PI", "PID"].includes(ct)
                ? parseFloat(ui.kpSlider.value)
                : 0,
              Ki: ["PI", "PID"].includes(ct)
                ? parseFloat(ui.kiSlider.value)
                : 0,
              Kd: ["PID"].includes(ct) ? parseFloat(ui.kdSlider.value) : 0,
              antiWindup: {
                enabled: ui.enableAntiWindup.checked,
                satMax: parseFloat(ui.satMax.value),
                satMin: parseFloat(ui.satMin.value),
              },
              derivFilter: {
                enabled: ui.enableDerivFilter.checked,
                N: parseFloat(ui.derivN.value),
              },
            };
          }
          const { time, output, diverged } = simulateSystem({
            ss,
            duration: simTime,
            dt,
            setpoint,
            controller,
          });
          if (diverged) {
            ui.statusMessage.textContent =
              "DIVERGENCE DETECTED: Simulation stopped.";
            ui.statusMessage.classList.add("diverged");
          }

          const stepAnalysis = analyzeStepResponse(time, output, setpoint);
          ui.overshootVal.textContent = stepAnalysis.overshoot;
          ui.settlingTimeVal.textContent = stepAnalysis.settlingTime;
          charts.step.data.datasets[0].data = stepAnalysis.bands;
          charts.step.data.datasets[1].data = time.map((t, i) => ({
            x: t,
            y: output[i],
          }));
          charts.step.data.datasets[2].data = time.map((t) => ({
            x: t,
            y: setpoint,
          }));
          charts.step.data.datasets[3].data = stepAnalysis.peakPoint;
          charts.step.options.scales.x.max = time[time.length - 1];
          charts.step.update();

          // --- Bode Plot ---
          let cNum_bode, cDen_bode;
          if (loopType === "open" || !controller) {
            cNum_bode = [1];
            cDen_bode = [1];
          } else {
            const ct = document.querySelector(
              'input[name="controller-type"]:checked'
            ).value;
            if (ct === "P") {
              cNum_bode = [controller.Kp];
              cDen_bode = [1];
            } else if (ct === "PI") {
              cNum_bode = [controller.Kp, controller.Ki];
              cDen_bode = [1, 0];
            } else {
              cNum_bode = [controller.Kd, controller.Kp, controller.Ki];
              cDen_bode = [1, 0];
            }
          }
          const openLoopNum = poly.multiply(cNum_bode, plantNum);
          const openLoopDen = poly.multiply(cDen_bode, plantDen);
          const startFreq = isInitialLoad
            ? 0.01
            : parseFloat(ui.bodeStartFreq.value);
          const endFreq = isInitialLoad
            ? 1000
            : parseFloat(ui.bodeEndFreq.value);
          const freqs = logspace(
            Math.log10(startFreq),
            Math.log10(endFreq),
            400
          );
          const { mags, phases } = calculateBodeData(
            openLoopNum,
            openLoopDen,
            freqs
          );
          const bodeAnalysis = analyzeBode(mags, phases);
          ui.gmVal.textContent = bodeAnalysis.gm;
          ui.pmVal.textContent = bodeAnalysis.pm;
          charts.mag.data.datasets[0].data = mags;
          charts.mag.data.datasets[1].data = bodeAnalysis.gmLine;
          charts.phase.data.datasets[0].data = phases;
          charts.phase.data.datasets[1].data = bodeAnalysis.pmLine;
          charts.mag.update();
          charts.phase.update();

          ui.calculateBtn.textContent = "Calculation Done";
        }

        // --- EVENT LISTENERS & UI ---
        function signalRecalculationNeeded() {
          ui.calculateBtn.classList.add("needs-recalc");
          ui.calculateBtn.textContent = "Calculate & Plot";
        }
        function handleSliderInput(e) {
          document.getElementById(`${e.target.id}-value`).textContent =
            e.target.value;
        }

        function updateGainVisibility() {
          const controllerType = document.querySelector(
            'input[name="controller-type"]:checked'
          ).value;
          const showP = ["P", "PI", "PID"].includes(controllerType);
          const showI = ["PI", "PID"].includes(controllerType);
          const showD = ["PID"].includes(controllerType);

          ui.kpGroup.style.display = showP ? "block" : "none";
          ui.kiGroup.style.display = showI ? "block" : "none";
          ui.kdGroup.style.display = showD ? "block" : "none";
        }
        
        function updateControllerOptionsVisibility() {
            const loopType = document.querySelector('input[name="loop-type"]:checked').value;
            if (loopType === 'open') {
                ui.controllerOptions.classList.add('hidden');
            } else {
                ui.controllerOptions.classList.remove('hidden');
            }
        }

        ui.calculateBtn.addEventListener("click", () => updatePlot(false));
        [...document.querySelectorAll("input")].forEach((input) =>
          input.addEventListener("input", signalRecalculationNeeded)
        );
        [
          ...document.querySelectorAll(
            "input[type=radio], input[type=checkbox]"
          ),
        ].forEach((input) =>
          input.addEventListener("change", signalRecalculationNeeded)
        );
        [...document.querySelectorAll(".slider-group input")].forEach(
          (slider) => slider.addEventListener("input", handleSliderInput)
        );
        ui.showAdvancedPid.addEventListener("change", () => {
          ui.advancedPidOptions.style.display = ui.showAdvancedPid.checked
            ? "block"
            : "none";
        });
        ui.tabButtons.forEach((button) => {
          button.addEventListener("click", (e) => {
            ui.tabButtons.forEach((btn) => btn.classList.remove("active"));
            e.currentTarget.classList.add("active");
            document
              .querySelectorAll(".plot-container")
              .forEach((c) => c.classList.remove("active"));
            document
              .getElementById(e.currentTarget.dataset.target)
              .classList.add("active");
          });
        });

        // --- Listeners for UI visibility ---
        ui.controllerTypeRadios.forEach((radio) => {
          radio.addEventListener("change", updateGainVisibility);
        });
        
        ui.loopTypeRadios.forEach(radio => {
            radio.addEventListener('change', updateControllerOptionsVisibility);
        });

        // --- Listeners for Help Modal ---
        ui.helpBtn.addEventListener("click", () => {
          ui.helpModal.classList.add("visible");
        });
        ui.modalCloseBtn.addEventListener("click", () => {
          ui.helpModal.classList.remove("visible");
        });
        ui.helpModal.addEventListener("click", (e) => {
          if (e.target === ui.helpModal) {
            ui.helpModal.classList.remove("visible");
          }
        });
        window.addEventListener("keydown", (e) => {
          if (e.key === "Escape" && ui.helpModal.classList.contains("visible")) {
            ui.helpModal.classList.remove("visible");
          }
        });

        // --- INITIALIZATION ---
        updateControllerOptionsVisibility(); 
        updateGainVisibility(); 
        updatePlot(true);
      });
    </script>
  </body>
</html>