<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EV Kart Powertrain Sizing | Engineering Project</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- FontAwesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- MathJax for Formulas -->
    <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f3f4f6; }
        .card { transition: transform 0.2s; }
        .card:hover { transform: translateY(-2px); }
        input[type=range]::-webkit-slider-thumb {
            -webkit-appearance: none;
            height: 16px;
            width: 16px;
            border-radius: 50%;
            background: #2563eb;
            cursor: pointer;
            margin-top: -6px;
        }
        /* Hide scrollbar for modal content */
        .no-scrollbar::-webkit-scrollbar {
            display: none;
        }
        .no-scrollbar {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }
        
        /* Print Styles */
        @media print {
            @page { margin: 1.0cm; size: A4; }
            body { background-color: white; color: black; -webkit-print-color-adjust: exact; }
            .no-print { display: none !important; }
            .print-only { display: block !important; }
            
            /* Report Typography */
            h1 { font-size: 24pt; color: #1e3a8a; border-bottom: 2px solid #1e3a8a; padding-bottom: 10px; margin-bottom: 20px; }
            h2 { font-size: 16pt; color: #1e40af; margin-top: 25px; border-bottom: 1px solid #ccc; page-break-after: avoid; }
            h3 { font-size: 13pt; color: #333; margin-top: 15px; font-weight: bold; }
            p, li { font-size: 11pt; line-height: 1.5; text-align: justify; margin-bottom: 8px; }
            
            .math-block { background-color: #f9fafb; border: 1px solid #e5e7eb; padding: 10px; border-radius: 5px; margin: 10px 0; page-break-inside: avoid; }
            .chart-print { width: 100%; height: auto; max-height: 300px; page-break-inside: avoid; margin-bottom: 20px; border: 1px solid #ddd; }
            .page-break { page-break-inside: avoid; }
            
            /* Force background colors for specs */
            .bg-blue-50 { background-color: #eff6ff !important; }
            .bg-green-50 { background-color: #f0fdf4 !important; }
            .border-blue-200 { border-color: #bfdbfe !important; }
            .border-green-200 { border-color: #bbf7d0 !important; }
        }
    </style>
</head>
<body class="text-gray-800">

    <!-- Navbar -->
    <nav class="bg-blue-900 text-white p-4 shadow-lg sticky top-0 z-40 no-print">
        <div class="container mx-auto flex justify-between items-center">
            <div class="flex items-center gap-3">
                <i class="fa-solid fa-car-battery text-2xl text-yellow-400"></i>
                <div>
                    <h1 class="text-xl font-bold hidden md:block">EV Kart Design Calculator</h1>
                    <h1 class="text-xl font-bold md:hidden">EV Kart Calc</h1>
                    <p class="text-xs text-blue-200 hidden md:block">Automobile Engineering Project Tool</p>
                </div>
            </div>
            <div class="flex gap-2">
                <button onclick="openModal()" class="text-sm bg-yellow-500 hover:bg-yellow-600 text-blue-900 font-bold px-3 py-1 rounded transition">
                    <i class="fa-solid fa-calculator"></i> <span class="hidden md:inline">View Calculations</span>
                </button>
                <button onclick="generateReport()" class="text-sm bg-blue-700 hover:bg-blue-600 px-3 py-1 rounded transition">
                    <i class="fa-solid fa-print"></i> <span class="hidden md:inline">Print Report</span>
                </button>
            </div>
        </div>
    </nav>

    <!-- Main Interactive Container (Hidden on Print) -->
    <div class="container mx-auto p-4 md:p-6 grid grid-cols-1 lg:grid-cols-12 gap-6 no-print">

        <!-- LEFT COLUMN: INPUTS -->
        <div class="lg:col-span-4 space-y-6">
            
            <div class="bg-white p-6 rounded-xl shadow-md border-l-4 border-blue-600">
                <h2 class="text-lg font-bold mb-4 flex items-center gap-2">
                    <i class="fa-solid fa-sliders"></i> Design Parameters
                </h2>
                
                <!-- Mass -->
                <div class="mb-4">
                    <label class="block text-sm font-semibold text-gray-700 mb-1">Total Mass (Driver + Kart)</label>
                    <div class="flex items-center gap-2">
                        <input type="number" id="inputMass" value="150" class="w-full p-2 border rounded focus:ring-2 focus:ring-blue-500 outline-none" oninput="calculate()">
                        <span class="text-gray-500 font-mono w-8">kg</span>
                    </div>
                </div>

                <!-- Distance -->
                <div class="mb-4">
                    <label class="block text-sm font-semibold text-gray-700 mb-1">Target Distance</label>
                    <div class="flex items-center gap-2">
                        <input type="number" id="inputDistance" value="100" class="w-full p-2 border rounded focus:ring-2 focus:ring-blue-500 outline-none" oninput="calculate()">
                        <span class="text-gray-500 font-mono w-8">m</span>
                    </div>
                </div>

                <!-- Time -->
                <div class="mb-4">
                    <label class="block text-sm font-semibold text-gray-700 mb-1">Target Time (to finish)</label>
                    <div class="flex items-center gap-2">
                        <input type="number" id="inputTime" value="10" step="0.1" class="w-full p-2 border rounded focus:ring-2 focus:ring-blue-500 outline-none" oninput="calculate()">
                        <span class="text-gray-500 font-mono w-8">s</span>
                    </div>
                </div>

                <!-- Wheel Diameter -->
                <div class="mb-4">
                    <label class="block text-sm font-semibold text-gray-700 mb-1">Wheel Diameter</label>
                    <div class="flex items-center gap-2">
                        <input type="number" id="inputWheel" value="11" step="0.5" class="w-full p-2 border rounded focus:ring-2 focus:ring-blue-500 outline-none" oninput="calculate()">
                        <span class="text-gray-500 font-mono w-8">in</span>
                    </div>
                </div>

                <!-- System Voltage -->
                <div class="mb-4">
                    <label class="block text-sm font-semibold text-gray-700 mb-1">System Voltage</label>
                    <select id="inputVoltage" class="w-full p-2 border rounded bg-gray-50 focus:ring-2 focus:ring-blue-500 outline-none" onchange="calculate()">
                        <option value="24">24V (Very Low Speed/Kids)</option>
                        <option value="36">36V (Low Speed)</option>
                        <option value="48">48V (Standard Cost)</option>
                        <option value="60">60V (Balanced)</option>
                        <option value="72" selected>72V (High Performance)</option>
                    </select>
                </div>

                <!-- Motor RPM Input (NEW) -->
                <div class="mb-4">
                    <label class="block text-sm font-semibold text-gray-700 mb-1">Motor Max RPM (Rated)</label>
                    <div class="flex items-center gap-2">
                        <input type="number" id="inputMotorRPM" value="4800" step="100" class="w-full p-2 border rounded focus:ring-2 focus:ring-blue-500 outline-none" oninput="calculate()">
                        <span class="text-gray-500 font-mono w-8">rpm</span>
                    </div>
                    <p class="text-xs text-gray-500 mt-1">Check motor spec sheet (typ. 3000-6000).</p>
                </div>

                <!-- Efficiency Factor -->
                <div class="mb-4">
                    <label class="block text-sm font-semibold text-gray-700 mb-1">
                        Safety Factor (Drag/Friction)
                        <span id="effVal" class="text-blue-600 ml-2">1.3x</span>
                    </label>
                    <input type="range" id="inputEff" min="1.1" max="1.5" step="0.1" value="1.3" class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer" oninput="updateEffLabel(); calculate();">
                </div>

                <!-- Battery Constraints -->
                <div class="border-t pt-4 mt-4 bg-gray-50 -mx-6 px-6 pb-2">
                    <h3 class="text-sm font-bold text-gray-800 mb-2 flex items-center gap-2">
                        <i class="fa-solid fa-battery-full text-green-600"></i> Battery Constraints
                    </h3>
                    <div class="grid grid-cols-2 gap-3">
                        <div>
                            <label class="block text-xs font-semibold text-gray-600 mb-1">Capacity (Ah)</label>
                            <input type="number" id="inputBatAh" value="30" class="w-full p-2 text-sm border rounded focus:ring-2 focus:ring-green-500 outline-none" oninput="calculate()">
                        </div>
                        <div>
                            <label class="block text-xs font-semibold text-gray-600 mb-1">C-Rating</label>
                            <input type="number" id="inputBatC" value="3" step="0.5" class="w-full p-2 text-sm border rounded focus:ring-2 focus:ring-green-500 outline-none" oninput="calculate()">
                        </div>
                    </div>
                    <p class="text-xs text-gray-500 mt-2">
                        Max Allowed Current: <strong id="dispMaxBatAmps">--</strong> A
                    </p>
                </div>
            </div>

        </div>

        <!-- RIGHT COLUMN: RESULTS -->
        <div class="lg:col-span-8 space-y-6">

            <!-- BATTERY CHECK BANNER -->
            <div id="batStatusBox" class="p-4 rounded-xl shadow-md flex items-center justify-between border-l-8 transition-colors duration-300 bg-gray-100 border-gray-400">
                <div class="flex items-center gap-4">
                    <div id="batIcon" class="text-3xl text-gray-400"><i class="fa-solid fa-circle-question"></i></div>
                    <div>
                        <h3 class="font-bold text-lg" id="batStatusTitle">Checking Constraints...</h3>
                        <p class="text-sm" id="batStatusDesc">Please check inputs.</p>
                    </div>
                </div>
                <div class="text-right">
                     <p class="text-xs font-bold uppercase text-gray-500">Load on Battery</p>
                     <p class="text-2xl font-bold" id="batLoadPct">0%</p>
                </div>
            </div>

            <!-- KPI Cards -->
            <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                <div class="bg-white p-4 rounded-xl shadow card border-t-4 border-emerald-500">
                    <p class="text-xs text-gray-500 uppercase font-bold">Exit Speed</p>
                    <h3 class="text-2xl font-bold text-gray-800" id="resSpeed">0</h3>
                    <p class="text-xs text-emerald-600">km/h</p>
                </div>
                <div class="bg-white p-4 rounded-xl shadow card border-t-4 border-red-500">
                    <p class="text-xs text-gray-500 uppercase font-bold">Peak Power Req</p>
                    <h3 class="text-2xl font-bold text-gray-800" id="resPower">0</h3>
                    <p class="text-xs text-red-600">kW (Kilowatts)</p>
                </div>
                <div class="bg-white p-4 rounded-xl shadow card border-t-4 border-indigo-500">
                    <p class="text-xs text-gray-500 uppercase font-bold">Motor Torque</p>
                    <h3 class="text-2xl font-bold text-gray-800" id="resMotorTorque">0</h3>
                    <p class="text-xs text-indigo-600">Nm (At Motor)</p>
                </div>
                <div class="bg-white p-4 rounded-xl shadow card border-t-4 border-orange-500">
                    <p class="text-xs text-gray-500 uppercase font-bold">Required Current</p>
                    <h3 class="text-2xl font-bold text-gray-800" id="resCurrent">0</h3>
                    <p class="text-xs text-orange-600">Amps (via Kt)</p>
                </div>
            </div>

            <!-- Charts Area -->
            <div class="bg-white p-4 rounded-xl shadow-md">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="font-bold text-gray-700">Performance Simulation</h3>
                    <div class="flex gap-2 text-sm bg-gray-100 p-1 rounded-lg">
                        <button onclick="switchChart('motion')" id="btnMotion" class="px-3 py-1 rounded-md bg-white shadow text-blue-700 font-semibold transition">Motion Profile</button>
                        <button onclick="switchChart('electrical')" id="btnElec" class="px-3 py-1 rounded-md text-gray-500 hover:text-blue-700 transition">Electrical Profile</button>
                    </div>
                </div>
                
                <div class="relative h-64 w-full">
                    <canvas id="motionChart"></canvas>
                    <canvas id="elecChart"></canvas>
                </div>
            </div>

            <!-- Engineering Recommendations -->
            <div class="bg-slate-800 text-white p-6 rounded-xl shadow-lg">
                <h3 class="text-lg font-bold mb-4 text-blue-300 border-b border-gray-600 pb-2">
                    <i class="fa-solid fa-wrench mr-2"></i>Engineering Recommendations
                </h3>
                
                <div class="grid md:grid-cols-2 gap-6 text-sm">
                    <div>
                        <h4 class="font-bold text-gray-400 mb-2 uppercase text-xs">Motor Parameters</h4>
                        <ul class="space-y-2">
                            <li class="flex justify-between">
                                <span>Est. Torque Constant (Kt):</span>
                                <span class="font-mono text-yellow-400" id="recKt">-- Nm/A</span>
                            </li>
                            <li class="flex justify-between">
                                <span>Suggested Rating:</span>
                                <span class="font-mono text-white" id="recMotorRating">Loading...</span>
                            </li>
                            <li class="flex justify-between">
                                <span>Input Max RPM:</span>
                                <span class="font-mono text-blue-300" id="recMotorRPM">-- RPM</span>
                            </li>
                        </ul>
                    </div>

                    <div>
                        <h4 class="font-bold text-gray-400 mb-2 uppercase text-xs">Transmission Design</h4>
                        <ul class="space-y-2">
                            <li class="flex justify-between">
                                <span>Wheel Torque Req:</span>
                                <span class="font-mono" id="resWheelTorque">0 Nm</span>
                            </li>
                            <li class="flex justify-between">
                                <span>Ideal Gear Ratio:</span>
                                <span class="font-mono text-green-400 font-bold text-lg" id="recGearRatio">Loading...</span>
                            </li>
                            <li class="text-xs text-gray-400 mt-1 italic">
                                *Calculated Ratio to hit top speed at finish line.
                            </li>
                        </ul>
                    </div>
                </div>
            </div>

        </div>
    </div>

    <!-- CALCULATION MODAL (Interactive) -->
    <div id="calcModal" class="fixed inset-0 bg-black bg-opacity-75 hidden z-50 flex justify-center items-center backdrop-blur-sm p-4 no-print">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-2xl max-h-[90vh] flex flex-col">
            <!-- Modal Header -->
            <div class="p-4 border-b flex justify-between items-center bg-gray-50 rounded-t-xl">
                <h3 class="font-bold text-lg text-gray-800"><i class="fa-solid fa-square-root-variable mr-2"></i>Step-by-Step Calculations</h3>
                <button onclick="closeModal()" class="text-gray-500 hover:text-red-500 text-xl font-bold">&times;</button>
            </div>
            
            <!-- Modal Body (Scrollable) -->
            <div class="p-6 overflow-y-auto" id="modalContent">
                <p class="text-center text-gray-500">Generating Calculation Steps...</p>
            </div>

            <!-- Modal Footer -->
            <div class="p-4 border-t bg-gray-50 text-right rounded-b-xl">
                <button onclick="closeModal()" class="px-4 py-2 bg-gray-200 hover:bg-gray-300 text-gray-800 rounded">Close</button>
            </div>
        </div>
    </div>

    <!-- PRINT REPORT CONTAINER (Visible only on print) -->
    <div id="print-container" class="hidden print-only bg-white text-black p-8 font-serif">
        <!-- Content injected via JS -->
    </div>

    <script>
        // -- Constants --
        const GRAVITY = 9.81;
        let chartMotion = null;
        let chartElec = null;

        // -- Initialization --
        window.onload = function() {
            initCharts();
            // Default to motion chart, hide electrical
            switchChart('motion');
            calculate();
        };

        // FIXED TAB SWITCHING LOGIC
        function switchChart(type) {
            const mCanvas = document.getElementById('motionChart');
            const eCanvas = document.getElementById('elecChart');
            const btnM = document.getElementById('btnMotion');
            const btnE = document.getElementById('btnElec');

            if(type === 'motion') {
                mCanvas.style.display = 'block';
                eCanvas.style.display = 'none';
                btnM.className = "px-3 py-1 rounded-md bg-white shadow text-blue-700 font-semibold transition";
                btnE.className = "px-3 py-1 rounded-md text-gray-500 hover:text-blue-700 transition";
            } else {
                mCanvas.style.display = 'none';
                eCanvas.style.display = 'block';
                btnM.className = "px-3 py-1 rounded-md text-gray-500 hover:text-blue-700 transition";
                btnE.className = "px-3 py-1 rounded-md bg-white shadow text-blue-700 font-semibold transition";
                // Force resize to fix Chart.js rendering on hidden containers
                if(chartElec) chartElec.resize();
            }
        }

        function openModal() {
            const modal = document.getElementById('calcModal');
            modal.classList.remove('hidden');
            renderMath('modalContent');
        }

        function closeModal() {
            const modal = document.getElementById('calcModal');
            modal.classList.add('hidden');
        }

        window.onclick = function(event) {
            const modal = document.getElementById('calcModal');
            if (event.target == modal) {
                closeModal();
            }
        }

        function updateEffLabel() {
            document.getElementById('effVal').innerText = document.getElementById('inputEff').value + 'x';
        }

        // State variables for MathJax
        let curCalcData = {};

        function calculate() {
            // 1. Get Inputs
            const mass = parseFloat(document.getElementById('inputMass').value) || 0;
            const distance = parseFloat(document.getElementById('inputDistance').value) || 0;
            const time = parseFloat(document.getElementById('inputTime').value) || 0;
            const wheelDiaInch = parseFloat(document.getElementById('inputWheel').value) || 0;
            const voltage = parseFloat(document.getElementById('inputVoltage').value);
            const safetyFactor = parseFloat(document.getElementById('inputEff').value);
            const motorMaxRPM = parseFloat(document.getElementById('inputMotorRPM').value) || 4800;
            
            const batAh = parseFloat(document.getElementById('inputBatAh').value) || 0;
            const batC = parseFloat(document.getElementById('inputBatC').value) || 0;

            if(mass <= 0 || distance <= 0 || time <= 0 || wheelDiaInch <= 0) return;

            // 2. Physics Calculations
            const acceleration = (2 * distance) / (time * time); // m/s^2
            const v_final_ms = acceleration * time; // m/s
            const v_final_kmh = v_final_ms * 3.6; // km/h

            const force_net = mass * acceleration; // Newtons
            const force_required = force_net * safetyFactor;
            const peak_power_watts = force_required * v_final_ms; 
            const peak_power_kw = peak_power_watts / 1000;

            const wheelDiaM = wheelDiaInch * 0.0254; // meters
            const wheelRadius = wheelDiaM / 2;
            const wheelCircumference = Math.PI * wheelDiaM;
            const torque_wheel = force_required * wheelRadius; // Nm
            const rpm_wheel = (v_final_ms / wheelCircumference) * 60;

            // -- Kt Based Current Calculation --
            const Kv = motorMaxRPM / voltage;
            const Kt = 9.5493 / Kv;
            const gear_ratio = motorMaxRPM / rpm_wheel;
            const torque_motor = torque_wheel / gear_ratio;
            const current_required = torque_motor / Kt;

            const power_check_watts = voltage * current_required; 
            
            const maxBatAmps = batAh * batC;
            const loadPercent = (current_required / maxBatAmps) * 100;
            const isOverload = current_required > maxBatAmps;

            let motorRecText = "";
            if(peak_power_kw < 2) motorRecText = "1000W - 1500W Rated";
            else if(peak_power_kw < 5) motorRecText = "2000W - 3000W Rated";
            else if(peak_power_kw < 10) motorRecText = "3000W - 5000W Rated (High Perf)";
            else motorRecText = "10kW+ Rated (Racing Class)";

            curCalcData = {
                mass, distance, time, acceleration, v_final_ms, v_final_kmh,
                force_net, safetyFactor, force_required, peak_power_watts, peak_power_kw,
                voltage, current_required, wheelDiaM, torque_wheel,
                motorMaxRPM, Kv, Kt, gear_ratio, torque_motor, power_check_watts, rpm_wheel,
                batAh, batC, motorRecText
            };

            // 4. Update DOM
            document.getElementById('resSpeed').innerText = v_final_kmh.toFixed(1);
            document.getElementById('resPower').innerText = peak_power_kw.toFixed(2);
            document.getElementById('resMotorTorque').innerText = torque_motor.toFixed(2);
            document.getElementById('resCurrent').innerText = current_required.toFixed(1);
            document.getElementById('dispMaxBatAmps').innerText = maxBatAmps.toFixed(0);
            
            document.getElementById('recKt').innerText = Kt.toFixed(4) + " Nm/A";
            document.getElementById('recGearRatio').innerText = gear_ratio.toFixed(1) + " : 1";
            document.getElementById('resWheelTorque').innerText = torque_wheel.toFixed(1) + " Nm";
            
            document.getElementById('recMotorRating').innerText = motorRecText;
            document.getElementById('recMotorRPM').innerText = motorMaxRPM + " RPM";

            const statusBox = document.getElementById('batStatusBox');
            const statusTitle = document.getElementById('batStatusTitle');
            const statusDesc = document.getElementById('batStatusDesc');
            const statusIcon = document.getElementById('batIcon');
            const loadPctText = document.getElementById('batLoadPct');

            loadPctText.innerText = loadPercent.toFixed(0) + "%";

            if (isOverload) {
                statusBox.className = "p-4 rounded-xl shadow-md flex items-center justify-between border-l-8 transition-colors duration-300 bg-red-50 border-red-500";
                statusTitle.innerText = "BATTERY OVERLOAD!";
                statusTitle.className = "font-bold text-lg text-red-700";
                statusDesc.innerText = `Req: ${current_required.toFixed(0)}A > Max: ${maxBatAmps.toFixed(0)}A. Upgrade Battery or Increase Voltage.`;
                statusIcon.innerHTML = '<i class="fa-solid fa-triangle-exclamation text-red-500"></i>';
            } else {
                if(loadPercent > 80) {
                    statusBox.className = "p-4 rounded-xl shadow-md flex items-center justify-between border-l-8 transition-colors duration-300 bg-yellow-50 border-yellow-500";
                    statusTitle.innerText = "Battery Heavy Load";
                    statusTitle.className = "font-bold text-lg text-yellow-700";
                    statusDesc.innerText = "Battery can handle it, but it's near the limit (>80%).";
                    statusIcon.innerHTML = '<i class="fa-solid fa-battery-half text-yellow-500"></i>';
                } else {
                    statusBox.className = "p-4 rounded-xl shadow-md flex items-center justify-between border-l-8 transition-colors duration-300 bg-green-50 border-green-500";
                    statusTitle.innerText = "Battery Status: SAFE";
                    statusTitle.className = "font-bold text-lg text-green-700";
                    statusDesc.innerText = "The battery pack is sufficient for this run.";
                    statusIcon.innerHTML = '<i class="fa-solid fa-circle-check text-green-500"></i>';
                }
            }

            // 5. Update Charts
            updateChartData(time, acceleration, voltage, force_required, Kt, gear_ratio, wheelRadius);
        }

        // GENERATE REPORT FUNCTION
        function generateReport() {
            const d = curCalcData;
            const today = new Date().toLocaleDateString();
            
            // Capture Charts Logic
            const mCanvas = document.getElementById('motionChart');
            const eCanvas = document.getElementById('elecChart');
            
            // Save state
            const wasMHidden = mCanvas.style.display === 'none';
            const wasEHidden = eCanvas.style.display === 'none';
            
            // Force show
            mCanvas.style.display = 'block';
            eCanvas.style.display = 'block';
            
            const imgM = mCanvas.toDataURL('image/png');
            const imgE = eCanvas.toDataURL('image/png');
            
            // Restore state
            if(wasMHidden) mCanvas.style.display = 'none';
            if(wasEHidden) eCanvas.style.display = 'none';

            const html = `
                <div>
                    <h1 class="text-3xl font-bold mb-2 border-b-4 border-black pb-2">EV Kart Powertrain Analysis Report</h1>
                    <p class="text-sm text-gray-600 mb-8 flex justify-between">
                        <span><strong>Project:</strong> Automobile Engineering Design</span>
                        <span><strong>Date:</strong> ${today}</span>
                    </p>
                    
                    <div class="mb-8">
                        <h2>1. Executive Summary</h2>
                        <p>This report outlines the powertrain sizing requirements for an electric go-kart designed to complete a <strong>${d.distance} meter</strong> sprint in <strong>${d.time} seconds</strong>. Based on the total mass of <strong>${d.mass} kg</strong> and a system voltage of <strong>${d.voltage}V</strong>, the analysis determines the required motor torque, power, battery capacity, and optimal gear ratio.</p>
                    </div>

                    <div class="grid grid-cols-2 gap-10 mb-8">
                        <div>
                            <h2 class="text-xl font-bold mb-3 uppercase tracking-wide bg-gray-100 p-1">2. Design Parameters</h2>
                            <table class="w-full text-sm">
                                <tr class="border-b"><td class="py-1">Total Mass</td><td class="font-mono text-right">${d.mass} kg</td></tr>
                                <tr class="border-b"><td class="py-1">Target Distance</td><td class="font-mono text-right">${d.distance} m</td></tr>
                                <tr class="border-b"><td class="py-1">Target Time</td><td class="font-mono text-right">${d.time} s</td></tr>
                                <tr class="border-b"><td class="py-1">System Voltage</td><td class="font-mono text-right">${d.voltage} V</td></tr>
                                <tr class="border-b"><td class="py-1">Wheel Diameter</td><td class="font-mono text-right">${(d.wheelDiaM/0.0254).toFixed(1)}"</td></tr>
                                <tr class="border-b"><td class="py-1">Safety Factor</td><td class="font-mono text-right">${d.safetyFactor}x</td></tr>
                            </table>
                        </div>
                        <div>
                            <h2 class="text-xl font-bold mb-3 uppercase tracking-wide bg-gray-100 p-1">3. Calculated Requirements</h2>
                            <table class="w-full text-sm">
                                <tr class="border-b"><td class="py-1 font-semibold">Exit Speed</td><td class="font-mono text-right font-bold">${d.v_final_kmh.toFixed(1)} km/h</td></tr>
                                <tr class="border-b"><td class="py-1 font-semibold">Peak Power</td><td class="font-mono text-right font-bold">${d.peak_power_kw.toFixed(2)} kW</td></tr>
                                <tr class="border-b"><td class="py-1">Motor Torque</td><td class="font-mono text-right">${d.torque_motor.toFixed(2)} Nm</td></tr>
                                <tr class="border-b"><td class="py-1">Required Current</td><td class="font-mono text-right">${d.current_required.toFixed(1)} A</td></tr>
                                <tr class="border-b"><td class="py-1">Optimal Gear Ratio</td><td class="font-mono text-right">${d.gear_ratio.toFixed(1)} : 1</td></tr>
                            </table>
                        </div>
                    </div>

                    <div class="mb-8 page-break">
                         <h2>4. Graphical Analysis</h2>
                         <div class="mb-6">
                            <h3>4.1 Motion Profile</h3>
                            <p>The chart below illustrates the velocity build-up and distance covered over time. The vehicle assumes a constant acceleration model to achieve the target distance within the target time.</p>
                            <img src="${imgM}" class="chart-print" alt="Motion Chart">
                         </div>
                         <div>
                            <h3>4.2 Electrical Profile</h3>
                            <p>This chart shows the theoretical power consumption and current draw. Note that peak power is required as velocity increases (overcoming drag and inertia), determining the maximum rating for the motor and controller.</p>
                            <img src="${imgE}" class="chart-print" alt="Electrical Chart">
                         </div>
                    </div>

                    <div class="mb-6">
                         <h2 class="text-xl font-bold mb-4 uppercase tracking-wide bg-gray-100 p-1">5. Mathematical Appendix</h2>
                         <p class="italic text-sm mb-4">Detailed step-by-step derivation of the values presented above.</p>
                         <div id="print-math-content" class="text-sm"></div> 
                    </div>

                    <div class="mb-6 page-break">
                        <h2>6. Conclusion & Specifications</h2>
                        <p class="mb-4">Based on the engineering analysis, the following component specifications are recommended to achieve the design goals:</p>
                        
                        <div class="grid grid-cols-2 gap-8">
                            <div class="bg-blue-50 p-4 rounded border border-blue-200">
                                <h3 class="text-lg font-bold text-blue-800 border-b border-blue-300 pb-2 mb-3">6.1 Motor & Transmission</h3>
                                <ul class="list-disc pl-5 space-y-2 text-sm">
                                    <li><strong>Motor Type:</strong> Brushless DC (BLDC)</li>
                                    <li><strong>System Voltage:</strong> ${d.voltage} V</li>
                                    <li><strong>Rated RPM:</strong> ${d.motorMaxRPM} RPM</li>
                                    <li><strong>Recommended Power:</strong> <span class="font-bold text-blue-900">${d.motorRecText}</span></li>
                                    <li><strong>Peak Torque Req:</strong> ${d.torque_motor.toFixed(1)} Nm</li>
                                    <li><strong>Gear Ratio:</strong> <span class="font-bold text-blue-900">${d.gear_ratio.toFixed(1)} : 1</span> (Motor : Axle)</li>
                                </ul>
                            </div>

                            <div class="bg-green-50 p-4 rounded border border-green-200">
                                <h3 class="text-lg font-bold text-green-800 border-b border-green-300 pb-2 mb-3">6.2 Battery Pack</h3>
                                <ul class="list-disc pl-5 space-y-2 text-sm">
                                    <li><strong>Nominal Voltage:</strong> ${d.voltage} V</li>
                                    <li><strong>Minimum Capacity:</strong> ${d.batAh} Ah</li>
                                    <li><strong>Peak Discharge Current:</strong> > <span class="font-bold text-green-900">${d.current_required.toFixed(0)} A</span></li>
                                    <li><strong>Recommended C-Rating:</strong> > <span class="font-bold text-green-900">${(d.current_required/d.batAh).toFixed(1)}C</span></li>
                                </ul>
                            </div>
                        </div>
                    </div>
                    
                    <div class="mt-8 border-t pt-4 text-center text-xs text-gray-500">
                        Generated by EV Kart Design Calculator Tool
                    </div>
                </div>
            `;
            
            document.getElementById('print-container').innerHTML = html;
            
            // Render math into the print container
            renderMath('print-math-content').then(() => {
                // Short delay to ensure rendering is complete before printing
                setTimeout(() => window.print(), 300);
            });
        }

        function renderMath(targetId) {
            const d = curCalcData;
            const content = document.getElementById(targetId);
            if (!content) return Promise.resolve();
            
            const html = `
            <div class="space-y-6 text-gray-800">
                <div class="math-block">
                    <h4 class="font-bold text-gray-700 mb-2 border-b pb-1">5.1 Acceleration & Force Calculation</h4>
                    <p>To move mass $m$ over distance $s$ in time $t$ starting from rest, we first calculate the required constant acceleration ($a$). We then derive the net force ($F_{net}$) using Newton's Second Law and apply a Safety Factor ($SF$) to account for air drag, rolling resistance, and mechanical inefficiencies.</p>
                    <div class="text-base p-2">
                        $$ a = \\frac{2s}{t^2} = \\frac{2 \\times ${d.distance}}{${d.time}^2} = \\mathbf{${d.acceleration.toFixed(2)} \\; m/s^2} $$
                        $$ F_{req} = m \\cdot a \\cdot SF = ${d.mass} \\cdot ${d.acceleration.toFixed(2)} \\cdot ${d.safetyFactor} = \\mathbf{${d.force_required.toFixed(0)} \\; N} $$
                    </div>
                </div>

                <div class="math-block">
                    <h4 class="font-bold text-gray-700 mb-2 border-b pb-1">5.2 Wheel Torque Requirement</h4>
                    <p>The linear force must be translated into rotational torque at the drive wheels. This depends on the wheel radius ($r_{wheel}$).</p>
                    <div class="text-base p-2">
                        $$ r_{wheel} = \\frac{Diameter}{2} = \\frac{${(d.wheelDiaM/0.0254).toFixed(1)} \\text{ in} \\times 0.0254}{2} = ${(d.wheelDiaM/2).toFixed(3)} \\text{ m} $$
                        $$ \\tau_{wheel} = F_{req} \\cdot r_{wheel} = ${d.force_required.toFixed(0)} \\cdot ${(d.wheelDiaM/2).toFixed(3)} = \\mathbf{${d.torque_wheel.toFixed(1)} \\; Nm} $$
                    </div>
                </div>

                <div class="math-block">
                    <h4 class="font-bold text-gray-700 mb-2 border-b pb-1">5.3 Transmission: Gear Ratio Selection</h4>
                    <p><strong>Reasoning:</strong> The electric motor is most efficient at its rated RPM. We must select a gear ratio that allows the motor to reach its rated speed (${d.motorMaxRPM} RPM) exactly when the vehicle reaches its target top speed.</p>
                    <p>First, we calculate the wheel RPM at the top speed (${d.v_final_kmh.toFixed(1)} km/h):</p>
                    <div class="text-base p-2">
                        $$ RPM_{wheel} = \\frac{v_{final}}{2 \\pi r_{wheel}} \\times 60 = \\frac{${d.v_final_ms.toFixed(2)}}{${(Math.PI * d.wheelDiaM).toFixed(3)}} \\times 60 = \\mathbf{${d.rpm_wheel.toFixed(0)} \\; RPM} $$
                    </div>
                    <p>Then, we define the Gear Ratio to match the Motor RPM to this Wheel RPM:</p>
                    <div class="text-base p-2">
                         $$ Ratio = \\frac{Motor_{RPM}}{Wheel_{RPM}} = \\frac{${d.motorMaxRPM}}{${d.rpm_wheel.toFixed(0)}} = \\mathbf{${d.gear_ratio.toFixed(1)} : 1} $$
                    </div>
                </div>

                <div class="math-block">
                     <h4 class="font-bold text-gray-700 mb-2 border-b pb-1">5.4 Motor Constants & Electrical Current</h4>
                     <p>We estimate the motor's Torque Constant ($K_t$) based on its velocity constant ($K_v$), derived from the system voltage and max RPM. This allows us to calculate the required current ($I$) to generate the necessary torque.</p>
                     <div class="text-base p-2">
                        $$ K_v = \\frac{RPM_{max}}{Voltage} = \\frac{${d.motorMaxRPM}}{${d.voltage}} = ${d.Kv.toFixed(1)} \\; RPM/V $$
                        $$ K_t \\approx \\frac{30}{\\pi \\cdot K_v} \\approx \\frac{9.55}{K_v} = \\mathbf{${d.Kt.toFixed(4)} \\; Nm/A} $$
                        $$ \\tau_{motor} = \\frac{\\tau_{wheel}}{Ratio} = \\frac{${d.torque_wheel.toFixed(1)}}{${d.gear_ratio.toFixed(1)}} = \\mathbf{${d.torque_motor.toFixed(2)} \\; Nm} $$
                        $$ I_{motor} = \\frac{\\tau_{motor}}{K_t} = \\frac{${d.torque_motor.toFixed(2)}}{${d.Kt.toFixed(4)}} = \\mathbf{${d.current_required.toFixed(1)} \\; Amps} $$
                     </div>
                </div>
            </div>
            `;
            
            content.innerHTML = html;
            
            if (window.MathJax) {
                return MathJax.typesetPromise([content]);
            }
            return Promise.resolve();
        }

        function initCharts() {
            const ctxM = document.getElementById('motionChart').getContext('2d');
            chartMotion = new Chart(ctxM, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [
                        { label: 'Velocity (km/h)', data: [], borderColor: '#3b82f6', backgroundColor: 'rgba(59, 130, 246, 0.1)', yAxisID: 'y', tension: 0.1, fill: true },
                        { label: 'Distance (m)', data: [], borderColor: '#10b981', backgroundColor: 'rgba(16, 185, 129, 0.1)', yAxisID: 'y1', tension: 0.4, fill: true }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: { mode: 'index', intersect: false },
                    scales: {
                        y: { type: 'linear', display: true, position: 'left', title: { display: true, text: 'Speed (km/h)' } },
                        y1: { type: 'linear', display: true, position: 'right', title: { display: true, text: 'Distance (m)' }, grid: { drawOnChartArea: false } },
                        x: { title: { display: true, text: 'Time (s)' } }
                    }
                }
            });

            const ctxE = document.getElementById('elecChart').getContext('2d');
            chartElec = new Chart(ctxE, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [
                        { label: 'Power (kW)', data: [], borderColor: '#ef4444', backgroundColor: 'rgba(239, 68, 68, 0.1)', yAxisID: 'y', tension: 0.1, fill: true },
                        { label: 'Current (A)', data: [], borderColor: '#f97316', backgroundColor: 'rgba(249, 115, 22, 0.1)', yAxisID: 'y1', tension: 0.1, fill: true }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: { mode: 'index', intersect: false },
                    scales: {
                        y: { type: 'linear', display: true, position: 'left', title: { display: true, text: 'Power (kW)' } },
                        y1: { type: 'linear', display: true, position: 'right', title: { display: true, text: 'Current (Amps)' }, grid: { drawOnChartArea: false } },
                        x: { title: { display: true, text: 'Time (s)' } }
                    }
                }
            });
        }

        function updateChartData(totalTime, accel, voltage, force, Kt, ratio, radius) {
            const steps = 20;
            const labels = [];
            const dataV = [];
            const dataD = [];
            const dataP = [];
            const dataI = [];
            
            const wheelTorque = force * radius;
            const motorTorque = wheelTorque / ratio;
            const currentReq = motorTorque / Kt; 

            for (let i = 0; i <= steps; i++) {
                const t = (totalTime / steps) * i;
                const v_ms = accel * t;
                const d_m = 0.5 * accel * t * t;
                const p_w = force * v_ms; 
                const p_kw = p_w / 1000;

                labels.push(t.toFixed(1));
                dataV.push((v_ms * 3.6).toFixed(1));
                dataD.push(d_m.toFixed(1));
                dataP.push(p_kw.toFixed(2));
                dataI.push(currentReq.toFixed(1));
            }

            if(chartMotion) {
                chartMotion.data.labels = labels;
                chartMotion.data.datasets[0].data = dataV;
                chartMotion.data.datasets[1].data = dataD;
                chartMotion.update();
            }

            if(chartElec) {
                chartElec.data.labels = labels;
                chartElec.data.datasets[0].data = dataP;
                chartElec.data.datasets[1].data = dataI;
                chartElec.update();
            }
        }
    </script>
</body>
</html>
