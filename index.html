<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>EV Performance & Range Simulator</title>
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
    <style>
      :root {
        --primary-bg: #f0f2f5;
        --secondary-bg: #ffffff;
        --text-color: #3a3a3a;
        --accent-color: #0d6efd;
        --border-color: #dee2e6;
        --shadow-color: rgba(0, 0, 0, 0.05);
        --plot-bg: #f3f4f6;
        --plot-grid-major: #e2e8f0;
        --plot-text: #525f7f;
        --plot-tooltip-bg: rgba(44, 53, 61, 0.8);
        --plot-tooltip-text: #ffffff;
        --color-consumption: #e8c4a2;
        --color-regen: #727b86;
      }
      body {
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto,
          "Helvetica Neue", Arial, sans-serif;
        background-color: var(--primary-bg);
        color: var(--text-color);
        margin: 0;
        display: flex;
        flex-direction: column;
        min-height: 100vh;
      }
      .container {
        display: flex;
        flex-grow: 1;
        padding: 20px;
        gap: 20px;
      }
      .sidebar {
        width: 340px;
        flex-shrink: 0;
        background-color: var(--secondary-bg);
        border-radius: 8px;
        padding: 20px;
        box-shadow: 0 4px 12px var(--shadow-color);
        overflow-y: auto;
      }
      .main-content {
        flex-grow: 1;
        display: flex;
        flex-direction: column;
        gap: 20px;
        position: relative;
      }

      h2,
      h3 {
        color: var(--accent-color);
        margin-top: 0;
      }
      h1 {
        margin-top: 0;
        margin-bottom: 0;
        color: #3a3a3a;
      }
      h2 {
        border-bottom: 2px solid var(--border-color);
        padding-bottom: 10px;
        margin-top: 20px;
        font-size: 1.3em;
      }
      h2:first-of-type {
        margin-top: 0;
      }
      h3 {
        border-bottom: none;
        font-size: 1.2em;
      }
      .form-group {
        margin-bottom: 15px;
      }
      .form-group label {
        display: block;
        font-weight: 600;
        margin-bottom: 5px;
        font-size: 0.9em;
      }
      .form-group input,
      .form-group select {
        width: 100%;
        padding: 8px;
        border: 1px solid var(--border-color);
        border-radius: 4px;
        box-sizing: border-box;
        background-color: var(--primary-bg);
      }
      .slider-group {
        display: flex;
        align-items: center;
        gap: 10px;
      }
      .slider-group input[type="range"] {
        flex-grow: 1;
      }
      .slider-group span {
        font-weight: bold;
        color: var(--accent-color);
        min-width: 40px;
        text-align: right;
      }
      .btn {
        width: 100%;
        padding: 12px;
        background-color: var(--accent-color);
        color: white;
        border: none;
        border-radius: 6px;
        font-size: 1.1em;
        font-weight: bold;
        cursor: pointer;
        transition: background-color 0.2s, transform 0.1s;
        text-align: center;
        margin-top: 10px;
      }
      .btn:hover {
        background-color: #0b5ed7;
      }
      .btn:active {
        transform: scale(0.98);
      }
      .btn.secondary {
        background-color: #6c757d;
      }
      .btn.secondary:hover {
        background-color: #5a6268;
      }
      /* New button states */
      .btn.warning {
        background-color: #ffc107;
        color: #212529;
      }
      .btn.warning:hover {
        background-color: #e0a800;
      }
      .btn.done {
        background-color: #0b5ed7;
        cursor: default;
      }
      .btn.done:hover {
        background-color: #3766ac;
        transform: scale(1.05);
      }
      .hidden {
        display: none !important;
      }

      .tab-switcher {
        display: flex;
        gap: 5px;
        border-bottom: 2px solid var(--border-color);
        margin-bottom: 20px;
      }
      .tab-btn {
        padding: 10px 20px;
        cursor: pointer;
        background: none;
        border: none;
        border-bottom: 3px solid transparent;
        font-size: 1.1em;
        font-weight: 600;
        color: #6c757d;
        transition: all 0.2s ease;
      }
      .tab-btn:hover {
        color: var(--accent-color);
      }
      .tab-btn.active {
        color: var(--accent-color);
        border-bottom-color: var(--accent-color);
      }
      .tab-panel {
        display: none;
        flex-direction: column;
        gap: 20px;
      }
      .tab-panel.active {
        display: flex;
      }

      .dashboard {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
        gap: 15px;
      }
      #performance-panel .dashboard {
        justify-content: flex-start;
        grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
        align-items: stretch;
      }
      .metric-card {
        background-color: var(--secondary-bg);
        padding: 20px;
        border-radius: 8px;
        box-shadow: 0 4px 12px var(--shadow-color);
        text-align: center;
        display: flex;
        flex-direction: column;
      }
      .metric-card .label {
        font-size: 0.9em;
        color: #666;
        margin-bottom: 8px;
      }
      .metric-card .value {
        font-size: 1.6em;
        font-weight: bold;
        color: var(--accent-color);
      }
      .plot-wrapper {
        position: relative;
        background-color: var(--secondary-bg);
        padding: 20px;
        border-radius: 8px;
        box-shadow: 0 4px 12px var(--shadow-color);
        display: flex;
        flex-direction: column;
        height: 400px;
      }
      .plot-wrapper canvas,
      .plot-wrapper > div {
        width: 100%;
        flex-grow: 1;
        min-height: 0;
        cursor: crosshair;
      }
      .plot-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 10px;
      }
      .plot-header h3 {
        margin: 0;
      }
      #drive-cycle-selector-container {
        display: flex;
        gap: 5px;
        flex-wrap: wrap;
        justify-content: flex-end;
      }
      .cycle-btn {
        border: none;
        background-color: transparent;
        color: var(--accent-color);
        padding: 4px 10px;
        border-radius: 4px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.2s ease-in-out;
      }
      .cycle-btn:hover:not(.active) {
        background-color: #e9ecef;
      }
      .cycle-btn.active {
        color: white;
        box-shadow: 0 2px 5px rgba(13, 110, 253, 0.3);
      }
      #wltp-btn.active {
        background-color: var(--accent-color);
      }
      #ftp75-btn.active {
        background-color: #2ca02c;
      }
      #nedc-btn.active {
        background-color: #f1a55f;
      }
      .plot-controls {
        margin-bottom: 15px;
      }

      .modal {
        display: none;
        position: fixed;
        z-index: 1000;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        overflow: auto;
        background-color: rgba(0, 0, 0, 0.4);
        align-items: center;
        justify-content: center;
      }
      .modal-content {
        background-color: #fefefe;
        margin: auto;
        padding: 20px;
        border: 1px solid #888;
        border-radius: 8px;
        width: 90%;
        max-width: 600px;
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
        animation: fadeIn 0.3s;
      }
      @keyframes fadeIn {
        from {
          opacity: 0;
          transform: translateY(-20px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }
      .modal-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding-bottom: 5px;
        margin-bottom: 10px;
      }
      .close-btn {
        color: #aaa;
        font-size: 28px;
        font-weight: bold;
        cursor: pointer;
      }
      .close-btn:hover {
        color: #333;
      }
      .modal-body {
        max-height: 70vh;
        overflow-y: auto;
      }
      .modal-body ul {
        list-style: none;
        padding-left: 0;
      }
      .modal-body li {
        background-color: var(--primary-bg);
        padding: 10px;
        border-radius: 4px;
        margin-bottom: 8px;
      }
      .rule-group {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 10px;
        align-items: center;
        margin-bottom: 15px;
      }
      .modal-footer {
        display: flex;
        gap: 10px;
        justify-content: flex-end;
        margin-top: 20px;
      }
      .heading-with-help {
        display: flex;
        align-items: center;
        justify-content: space-between;
      }
      #help-btn {
        width: 28px;
        height: 28px;
        border-radius: 50%;
        border: 2px solid var(--accent-color);
        background-color: var(--secondary-bg);
        color: var(--accent-color);
        font-size: 16px;
        font-weight: bold;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        transition: all 0.2s ease;
        margin-left: 10px;
      }
      #help-btn:hover {
        background-color: var(--accent-color);
        color: white;
        transform: scale(1.1);
      }
      .results-table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 15px;
        flex-grow: 1;
      }

      .results-table th,
      .results-table td {
        padding: 10px;
        text-align: left;
        border-bottom: 1px solid var(--border-color);
      }
      .results-table td:last-child {
        text-align: right;
        font-weight: 600;
      }

      .results-table thead th {
        background-color: #f8f9fa;
        font-weight: 600;
        border-bottom-width: 2px;
      }

      .results-table tbody tr:last-child td {
        border-bottom: none;
      }
      .result-card .value {
        font-size: 2.2em;
        font-weight: bold;
        color: #007bff;
        margin: 5px 0;
      }
      .result-card .value.error {
        color: #dc3545;
        font-size: 1.5em;
      }

      #max-speed-table th,
      #max-speed-table td {
        text-align: center;
      }

      @media (max-width: 900px) {
        .container {
          flex-direction: column;
        }
        .sidebar {
          width: 100%;
          box-sizing: border-box;
        }
      }
    </style>
  </head>
  <body>
    <div class="container">
      <aside class="sidebar">
        <form id="ev-form">
          <div class="form-group">
            <label for="model-select">Select Vehicle Model</label>
            <select id="model-select">
              <option value="custom">Custom Model</option>
              <option value="tesla_model_3_lr">Tesla Model 3 Highland (RWD)</option>
              <option value="bmw_i4_edrive40">BMW i4 (eDrive40)</option>
              <option value="porsche_taycan_rwd">Porsche Taycan (RWD)</option>
              <option value="tesla_model_y_lr">Tesla Model Y (LR)</option>
              <option value="bmw_ix_xdrive50">BMW iX (xDrive50)</option>
            </select>
          </div>

          <div class="heading-with-help">
            <h2>Vehicle Parameters</h2>
            <button type="button" id="help-btn" title="Open Help Guide">
              ?
            </button>
          </div>
          <div class="form-group">
            <label for="mass">Vehicle Mass (kg)</label
            ><input type="number" id="mass" value="1750" min="500" step="1" />
          </div>
          <div class="form-group">
            <label for="cd">Drag Coefficient (Cd)</label
            ><input
              type="number"
              id="cd"
              value="0.29"
              min="0.15"
              max="0.5"
              step="0.01"
            />
          </div>
          <div class="form-group">
            <label for="frontal-area">Frontal Area (m²)</label
            ><input
              type="number"
              id="frontal-area"
              value="2.4"
              min="1.5"
              max="4.0"
              step="0.01"
            />
          </div>
          <div class="form-group">
            <label for="wheel-radius">Wheel Radius (m)</label
            ><input
              type="number"
              id="wheel-radius"
              value="0.34"
              min="0.25"
              max="0.5"
              step="0.001"
            />
          </div>
          <div class="form-group">
            <label for="crr">Rolling Resistance Coeff. (Crr)</label
            ><input
              type="number"
              id="crr"
              value="0.009"
              min="0.005"
              max="0.02"
              step="0.001"
            />
          </div>
          <div class="form-group">
            <label for="gear-ratio">Gear Ratio</label
            ><input
              type="number"
              id="gear-ratio"
              value="9.1"
              min="5.0"
              max="15.0"
              step="0.01"
            />
          </div>

          <div id="param-group-perf" class="hidden">
            <h2>Performance Analysis Parameters</h2>
            <div class="form-group">
              <label for="max-torque">Max Motor Torque (Nm)</label
              ><input
                type="number"
                id="max-torque"
                value="310"
                min="50"
                step="1"
              />
            </div>
            <div class="form-group">
              <label for="max-power">Max Motor Power (kW)</label
              ><input
                type="number"
                id="max-power"
                value="150"
                min="20"
                step="1"
              />
            </div>
            <div class="form-group">
              <label for="efficiency">Drivetrain Efficiency (%):</label
              ><input type="number" id="efficiency" step="1" value="90" />
            </div>
            <div class="form-group">
              <label for="mass-factor">Rotational Mass Factor (%)</label
              ><input
                type="number"
                id="mass-factor"
                value="5"
                min="0"
                max="15"
                step="1"
              />
            </div>
          </div>

          <div id="param-group-range">
            <h2>Range Simulation Parameters</h2>
            <div class="form-group">
              <label for="drivetrain-eff">Drivetrain Efficiency (%)</label>
              <div class="slider-group">
                <input
                  type="number"
                  id="drivetrain-eff"
                  step="1"
                  value="90"
                  min="80"
                  max="98"
                />
              </div>
            </div>
            <div class="form-group">
              <label for="motor-eff">Motor & Inverter Efficiency (%)</label>
              <div class="slider-group">
                <input
                  type="number"
                  id="motor-eff"
                  step="1"
                  value="90"
                  min="80"
                  max="98"
                />
              </div>
            </div>
            <div class="form-group">
              <label for="battery-capacity">Battery Capacity (kWh)</label>
              <div class="slider-group">
                <input
                  type="range"
                  id="battery-capacity"
                  value="60.5"
                  min="10"
                  max="200"
                  step="0.1"
                /><span id="battery-capacity-value" data-unit=" kWh"
                  >60.5 kWh</span
                >
              </div>
            </div>
            <div class="form-group">
              <label for="max-regen-c-rate">Max Regen Rate (C-rate)</label
              ><input
                type="number"
                id="max-regen-c-rate"
                value="2"
                min="0.1"
                max="5"
                step="0.01"
              />
            </div>
            <div class="form-group">
              <label for="regen-strategy">Select Strategy</label
              ><select id="regen-strategy">
                <option value="none">No Regeneration</option>
                <option value="simple" selected>Simple (Fixed %)</option>
                <option value="rule-based">Rule-Based</option>
              </select>
            </div>
            <div class="form-group" id="configure-rules-container">
              <button
                type="button"
                class="btn secondary"
                id="configure-rules-btn"
              >
                Configure Strategy
              </button>
            </div>
          </div>

          <button type="submit" class="btn" id="run-range-btn">
            Run Range Simulation
          </button>
          <button type="submit" class="btn hidden" id="run-perf-btn">
            Run Performance Simulation
          </button>
        </form>
      </aside>

      <main class="main-content">
        <header>
          <h1>EV Simulator</h1>
          <h2 id="model-title">Custom Model</h2>
        </header>

        <div class="tab-switcher">
          <button class="tab-btn active" data-tab="range-panel">
            Range & Consumption
          </button>
          <button class="tab-btn" data-tab="performance-panel">
            Performance Analysis
          </button>
        </div>

        <div id="range-panel" class="tab-panel active">
          <section class="dashboard">
            <div class="metric-card">
              <div class="label">Run Time</div>
              <div class="value" id="summary-time">- min</div>
            </div>
            <div class="metric-card">
              <div class="label">Distance</div>
              <div class="value" id="summary-distance">- km</div>
            </div>
            <div class="metric-card">
              <div class="label">Net Energy Used</div>
              <div class="value" id="summary-energy">- kWh</div>
            </div>
            <div class="metric-card">
              <div class="label">Energy Used (%)</div>
              <div class="value" id="summary-energy-percent">- %</div>
            </div>
            <div class="metric-card">
              <div class="label">Consumption Rate</div>
              <div class="value" id="summary-consumption">- kWh/100km</div>
            </div>
            <div class="metric-card">
              <div class="label" id="summary-range-label">Est. Range</div>
              <div class="value" id="summary-range">- km</div>
            </div>
          </section>
          <section class="plot-wrapper">
            <div class="plot-header">
              <h3>Drive Cycle Speed Profile</h3>
              <div id="drive-cycle-selector-container">
                <button
                  type="button"
                  class="cycle-btn"
                  id="nedc-btn"
                  data-cycle="nedc"
                >
                  NEDC
                </button>
                <button
                  type="button"
                  class="cycle-btn"
                  id="ftp75-btn"
                  data-cycle="ftp75"
                >
                  FTP-75
                </button>
                <button
                  type="button"
                  class="cycle-btn"
                  id="wltp-btn"
                  data-cycle="wltp"
                >
                  WLTP
                </button>
              </div>
            </div>
            <canvas id="plot-canvas-speed"></canvas>
          </section>
          <section class="plot-wrapper">
            <div class="plot-controls">
              <label for="plot-selector"><strong>Select Metric: </strong></label
              ><select id="plot-selector">
                <option value="acceleration">Acceleration (km/h/s)</option>
                <option value="wheelForce">Wheel Force (N)</option>
                <option value="motorTorque">Motor Torque (Nm)</option>
                <option value="batteryPower" selected>
                  Battery Power (kW)
                </option>
                <option value="cumulativeEnergy">
                  Cumulative Energy (kWh)
                </option>
              </select>
            </div>
            <canvas id="plot-canvas-secondary"></canvas>
          </section>
        </div>

        <div id="performance-panel" class="tab-panel">
          <section class="dashboard">
            <div class="metric-card result-card" style="text-align: left">
              <h3 style="text-align: center">Max. Climbing Slope</h3>
              <div
                style="
                  display: flex;
                  justify-content: space-between;
                  align-items: center;
                  margin-bottom: 12px;
                  margin-top: 10px;
                "
              >
                <label for="perf-target-speed">Target Speed (km/h):</label>
                <input
                  type="number"
                  id="perf-target-speed"
                  value="60"
                  style="
                    width: 100px;
                    padding: 6px;
                    border: 1px solid var(--border-color);
                    border-radius: 4px;
                    text-align: center;
                    background-color: var(--secondary-bg);
                  "
                />
              </div>
              <div
                style="text-align: center; margin-top: auto; padding-top: 10px"
              >
                <p>Constant Speed Climbing</p>
                <p class="value" id="max-grade-result-val">-°</p>
              </div>
            </div>
            <div class="metric-card result-card" style="text-align: left">
              <h3 style="text-align: center">Acceleration Analysis</h3>
              <div
                style="
                  display: flex;
                  justify-content: space-between;
                  align-items: center;
                  margin-bottom: 12px;
                  margin-top: 10px;
                "
              >
                <label for="perf-accel-start">Start Speed (km/h):</label>
                <input
                  type="number"
                  id="perf-accel-start"
                  value="0"
                  style="
                    width: 100px;
                    padding: 6px;
                    border: 1px solid var(--border-color);
                    border-radius: 4px;
                    text-align: center;
                    background-color: var(--secondary-bg);
                  "
                />
              </div>
              <div
                style="
                  display: flex;
                  justify-content: space-between;
                  align-items: center;
                  margin-bottom: 12px;
                "
              >
                <label for="perf-accel-end">End Speed (km/h):</label>
                <input
                  type="number"
                  id="perf-accel-end"
                  value="100"
                  style="
                    width: 100px;
                    padding: 6px;
                    border: 1px solid var(--border-color);
                    border-radius: 4px;
                    text-align: center;
                    background-color: var(--secondary-bg);
                  "
                />
              </div>
              <div
                style="
                  display: flex;
                  justify-content: space-between;
                  align-items: center;
                  margin-bottom: 12px;
                "
              >
                <label for="perf-accel-grade">Grade (degrees):</label>
                <input
                  type="number"
                  id="perf-accel-grade"
                  value="0"
                  style="
                    width: 100px;
                    padding: 6px;
                    border: 1px solid var(--border-color);
                    border-radius: 4px;
                    text-align: center;
                    background-color: var(--secondary-bg);
                  "
                />
              </div>
              <div
                style="text-align: center; margin-top: auto; padding-top: 10px"
              >
                <p id="accel-result-title">Time to accelerate:</p>
                <p class="value" id="accel-result-val">- s</p>
                <p id="accel-result-slope">on a <strong>0°</strong> slope.</p>
              </div>
            </div>
            <div
              class="metric-card"
              style="text-align: left; padding-top: 20px"
            >
              <h3 style="text-align: center">Maximum Sustainable Speed</h3>
              <table class="results-table" id="max-speed-table">
                <thead>
                  <tr>
                    <th>Grade (degrees)</th>
                    <th>Max Speed (km/h)</th>
                  </tr>
                </thead>
                <tbody id="max-speed-table-body">
                  <!-- Populated by JS -->
                </tbody>
              </table>
            </div>
          </section>
          <section class="plot-wrapper">
            <div id="motorPlotContainer"></div>
          </section>
          <section class="plot-wrapper">
            <div id="vehiclePlotContainer"></div>
          </section>
        </div>
      </main>
    </div>

    <div id="rules-modal" class="modal">
      <div class="modal-content">
        <header class="modal-header">
          <h2>Configure Regeneration</h2>
          <span class="close-btn" id="close-rules-btn">×</span>
        </header>
        <form id="rules-form">
          <div id="modal-simple-rule">
            <p>
              Set a single, fixed percentage of braking power to be regenerated.
            </p>
            <div class="form-group">
              <label for="rule-simple-percent">Fixed Regen Power (%)</label
              ><input
                type="number"
                id="rule-simple-percent"
                value="50"
                min="0"
                max="100"
              />
            </div>
          </div>
          <div id="modal-rule-based-rules">
            <p>
              Rules are applied from highest deceleration to lowest. Set
              thresholds in km/h/s.
            </p>
            <div class="rule-group">
              <label for="rule-high-decel">High Decel (decel >)</label
              ><input
                type="number"
                id="rule-high-decel"
                value="1.5"
                step="0.1"
              /><label for="rule-high-percent">Regen Power (%)</label
              ><input
                type="number"
                id="rule-high-percent"
                value="75"
                min="0"
                max="100"
              />
            </div>
            <div class="rule-group">
              <label for="rule-med-decel">Medium Decel (decel >)</label
              ><input
                type="number"
                id="rule-med-decel"
                value="1.25"
                step="0.1"
              /><label for="rule-med-percent">Regen Power (%)</label
              ><input
                type="number"
                id="rule-med-percent"
                value="50"
                min="0"
                max="100"
              />
            </div>
            <div class="rule-group">
              <label for="rule-low-decel">Low Decel (decel >)</label
              ><input
                type="number"
                id="rule-low-decel"
                value="0"
                step="0.1"
                readonly
              /><label for="rule-low-percent">Regen Power (%)</label
              ><input
                type="number"
                id="rule-low-percent"
                value="100"
                min="0"
                max="100"
              />
            </div>
          </div>
          <footer class="modal-footer">
            <button type="button" id="cancel-rules-btn" class="btn secondary">
              Cancel</button
            ><button type="submit" id="save-rules-btn" class="btn">
              Save Rules
            </button>
          </footer>
        </form>
      </div>
    </div>
    <div id="help-modal" class="modal">
      <div class="modal-content">
        <header class="modal-header">
          <h2>Parameters Guide</h2>
          <span class="close-btn" id="close-help-btn">×</span>
        </header>
        <div class="modal-body">
          <h3>1. Vehicle Mass & Inertia</h3>
          <ul>
            <li>
              <strong>Vehicle Mass (kg):</strong> The total mass of the vehicle,
              including the battery, driver, and any payload.
            </li>
          </ul>
          <h3>2. Aerodynamic Properties</h3>
          <ul>
            <li>
              <strong>Drag Coefficient (Cd):</strong> A dimensionless number
              that describes how aerodynamically streamlined the vehicle's shape
              is.
            </li>
            <li>
              <strong>Frontal Area (m²):</strong> The cross-sectional area of
              the vehicle from a direct frontal view.
            </li>
          </ul>
          <h3>3. Tire & Road Interaction</h3>
          <ul>
            <li>
              <strong>Wheel Radius (m):</strong> The radius from the center of
              the wheel to the outer edge of the tyre.
            </li>
            <li>
              <strong>Rolling Resistance Coefficient (Crr):</strong> A
              dimensionless number representing the friction from the tyres
              deforming as they roll.
            </li>
          </ul>
          <h3>4. Powertrain & Efficiency</h3>
          <ul>
            <li>
              <strong>Gear Ratio:</strong> The fixed gear reduction ratio
              between the motor and the wheels.
            </li>
            <li>
              <strong>Motor & Inverter Efficiency (%):</strong> The efficiency
              of converting DC electrical power into mechanical rotational
              power.
            </li>
            <li>
              <strong>Drivetrain Efficiency (%):</strong> The efficiency of
              transmitting mechanical power from the motor to the wheels.
            </li>
          </ul>
          <h3>5. Energy & Regeneration</h3>
          <ul>
            <li>
              <strong>Battery Capacity (kWh):</strong> The total amount of
              usable energy stored in the battery pack. This is the primary
              determinant of vehicle range.
            </li>
            <li>
              <strong>Max Regenerative Braking Rate (C-rate):</strong> The
              maximum rate at which the battery can be recharged by the motor
              during deceleration. Formula: Max Regen Power (kW) = C-rate ×
              Battery Capacity (kWh).
            </li>
          </ul>
        </div>
      </div>
    </div>

    <script>
      document.addEventListener("DOMContentLoaded", () => {
        // --- 1. CONFIGURATION & STATE ---
        const PHYSICS = { g: 9.81, rho: 1.225 };
        const RAW_NEDC_DATA = [
          [0, 0],
          [11, 15],
          [15, 15],
          [23, 0],
          [28, 0],
          [49, 15],
          [55, 32],
          [61, 32],
          [85, 0],
          [96, 0],
          [117, 15],
          [123, 35],
          [134, 50],
          [143, 50],
          [155, 35],
          [163, 35],
          [178, 0],
          [188, 0],
          [195, 0],
          [206, 15],
          [210, 15],
          [218, 0],
          [223, 0],
          [244, 15],
          [250, 32],
          [256, 32],
          [280, 0],
          [291, 0],
          [312, 15],
          [318, 35],
          [329, 50],
          [338, 50],
          [350, 35],
          [358, 35],
          [373, 0],
          [383, 0],
          [390, 0],
          [401, 15],
          [405, 15],
          [413, 0],
          [418, 0],
          [439, 15],
          [445, 32],
          [451, 32],
          [475, 0],
          [486, 0],
          [507, 15],
          [513, 35],
          [524, 50],
          [533, 50],
          [545, 35],
          [553, 35],
          [568, 0],
          [578, 0],
          [585, 0],
          [596, 15],
          [600, 15],
          [608, 0],
          [613, 0],
          [634, 15],
          [640, 32],
          [646, 32],
          [670, 0],
          [681, 0],
          [702, 15],
          [708, 35],
          [719, 50],
          [728, 50],
          [740, 35],
          [748, 35],
          [763, 0],
          [773, 0],
          [780, 0],
          [800, 15],
          [806, 35],
          [817, 50],
          [827, 70],
          [841, 70],
          [891, 50],
          [899, 50],
          [968, 70],
          [981, 70],
          [1031, 100],
          [1066, 100],
          [1096, 120],
          [1116, 120],
          [1126, 80],
          [1142, 50],
          [1150, 0],
          [1160, 0],
          [1180, 0],
        ];
        const RAW_WLTP_VELOCITIES = [
          0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.2, 1.7,
          5.4, 9.9, 13.1, 16.9, 21.7, 26.0, 27.5, 28.1, 28.3, 28.8, 29.1, 30.8,
          31.9, 34.1, 36.6, 39.1, 41.3, 42.5, 43.3, 43.9, 44.4, 44.5, 44.2,
          42.7, 39.9, 37.0, 34.6, 32.3, 29.0, 25.1, 22.2, 20.9, 20.4, 19.5,
          18.4, 17.8, 17.8, 17.4, 15.7, 13.1, 12.1, 12.0, 12.0, 12.0, 12.3,
          12.6, 14.7, 15.3, 15.9, 16.2, 17.1, 17.8, 18.1, 18.4, 20.3, 23.2,
          26.5, 29.8, 32.6, 34.4, 35.5, 36.4, 37.4, 38.5, 39.3, 39.5, 39.0,
          38.5, 37.3, 37.0, 36.7, 35.9, 35.3, 34.6, 34.2, 31.9, 27.3, 22.0,
          17.0, 14.2, 12.0, 9.1, 5.8, 3.6, 2.2, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0,
          0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0,
          0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0,
          0.0, 0.0, 0.0, 0.0, 0.0, 0.2, 1.9, 6.1, 11.7, 16.4, 18.9, 19.9, 20.8,
          22.8, 25.4, 27.7, 29.2, 29.8, 29.4, 27.2, 22.6, 17.3, 13.3, 12.0,
          12.6, 14.1, 17.2, 20.1, 23.4, 25.5, 27.6, 29.5, 31.1, 32.1, 33.2,
          35.2, 37.2, 38.0, 37.4, 35.1, 31.0, 27.1, 25.3, 25.1, 25.9, 27.8,
          29.2, 29.6, 29.5, 29.2, 28.3, 26.1, 23.6, 21.0, 18.9, 17.1, 15.7,
          14.5, 13.7, 12.9, 12.5, 12.2, 12.0, 12.0, 12.0, 12.0, 12.5, 13.0,
          14.0, 15.0, 16.5, 19.0, 21.2, 23.8, 26.9, 29.6, 32.0, 35.2, 37.5,
          39.2, 40.5, 41.6, 43.1, 45.0, 47.1, 49.0, 50.6, 51.8, 52.7, 53.1,
          53.5, 53.8, 54.2, 54.8, 55.3, 55.8, 56.2, 56.5, 56.5, 56.2, 54.9,
          52.9, 51.0, 49.8, 49.2, 48.4, 46.9, 44.3, 41.5, 39.5, 37.0, 34.6,
          32.3, 29.0, 25.1, 22.2, 20.9, 20.4, 19.5, 18.4, 17.8, 17.8, 17.4,
          15.7, 14.5, 15.4, 17.9, 20.6, 23.2, 25.7, 28.7, 32.5, 36.1, 39.0,
          40.8, 42.9, 44.4, 45.9, 46.0, 45.6, 45.3, 43.7, 40.8, 38.0, 34.4,
          30.9, 25.5, 21.4, 20.2, 22.9, 26.6, 30.2, 34.1, 37.4, 40.7, 44.0,
          47.3, 49.2, 49.8, 49.2, 48.1, 47.3, 46.8, 46.7, 46.8, 47.1, 47.3,
          47.3, 47.1, 46.6, 45.8, 44.8, 43.3, 41.8, 40.8, 40.3, 40.1, 39.7,
          39.2, 38.5, 37.4, 36.0, 34.4, 33.0, 31.7, 30.0, 28.0, 26.1, 25.6,
          24.9, 24.9, 24.3, 23.9, 23.9, 23.6, 23.3, 20.5, 17.5, 16.9, 16.7,
          15.9, 15.6, 15.0, 14.5, 14.3, 14.5, 15.4, 17.8, 21.1, 24.1, 25.0,
          25.3, 25.5, 26.4, 26.6, 27.1, 27.7, 28.1, 28.2, 28.1, 28.0, 27.9,
          27.9, 28.1, 28.2, 28.0, 26.9, 25.0, 23.2, 21.9, 21.1, 20.7, 20.7,
          20.8, 21.2, 22.1, 23.5, 24.3, 24.5, 23.8, 21.3, 17.7, 14.4, 11.9,
          10.2, 8.9, 8.0, 7.2, 6.1, 4.9, 3.7, 2.3, 0.9, 0.0, 0.0, 0.0, 0.0, 0.0,
          0.0, 0.5, 2.1, 4.8, 8.3, 12.3, 16.6, 20.9, 24.2, 25.6, 25.6, 24.9,
          23.3, 21.6, 20.2, 18.7, 17.0, 15.3, 14.2, 13.9, 14.0, 14.2, 14.5,
          14.9, 15.9, 17.4, 18.7, 19.1, 18.8, 17.6, 16.6, 16.2, 16.4, 17.2,
          19.1, 22.6, 27.4, 31.6, 33.4, 33.5, 32.8, 31.9, 31.3, 31.1, 30.6,
          29.2, 26.7, 23.0, 18.2, 12.9, 7.7, 3.8, 1.3, 0.2, 0.0, 0.0, 0.0, 0.0,
          0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0,
          0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0,
          0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0,
          0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0,
          0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.5, 2.5, 6.6, 11.8, 16.8, 20.5,
          21.9, 21.9, 21.3, 20.3, 19.2, 17.8, 15.5, 11.9, 7.6, 4.0, 2.0, 1.0,
          0.0, 0.0, 0.0, 0.2, 1.2, 3.2, 5.2, 8.2, 13.0, 18.8, 23.1, 24.5, 24.5,
          24.3, 23.6, 22.3, 20.1, 18.5, 17.2, 16.3, 15.4, 14.7, 14.3, 13.7,
          13.3, 13.1, 13.1, 13.3, 13.8, 14.5, 16.5, 17.0, 17.0, 17.0, 15.4,
          10.1, 4.8, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0,
          0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0,
          0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 1.0, 2.1, 4.8, 9.1, 14.2,
          19.8, 25.5, 30.5, 34.8, 38.8, 42.9, 46.4, 48.3, 48.7, 48.5, 48.4,
          48.2, 47.8, 47.0, 45.9, 44.9, 44.4, 44.3, 44.5, 45.1, 45.7, 46.0,
          46.0, 46.0, 46.1, 46.7, 47.7, 48.9, 50.3, 51.6, 52.6, 53.0, 53.0,
          52.9, 52.7, 52.6, 53.1, 54.3, 55.2, 55.5, 55.9, 56.3, 56.7, 56.9,
          56.8, 56.0, 54.2, 52.1, 50.1, 47.2, 43.2, 39.2, 36.5, 34.3, 31.0,
          26.0, 20.7, 15.4, 13.1, 12.0, 12.5, 14.0, 19.0, 23.2, 28.0, 32.0,
          34.0, 36.0, 38.0, 40.0, 40.3, 40.5, 39.0, 35.7, 31.8, 27.1, 22.8,
          21.1, 18.9, 18.9, 21.3, 23.9, 25.9, 28.4, 30.3, 30.9, 31.1, 31.8,
          32.7, 33.2, 32.4, 28.3, 25.8, 23.1, 21.8, 21.2, 21.0, 21.0, 20.9,
          19.9, 17.9, 15.1, 12.8, 12.0, 13.2, 17.1, 21.1, 21.8, 21.2, 18.5,
          13.9, 12.0, 12.0, 13.0, 16.0, 18.5, 20.6, 22.5, 24.0, 26.6, 29.9,
          34.8, 37.8, 40.2, 41.6, 41.9, 42.0, 42.2, 42.4, 42.7, 43.1, 43.7,
          44.0, 44.1, 45.3, 46.4, 47.2, 47.3, 47.4, 47.4, 47.5, 47.9, 48.6,
          49.4, 49.8, 49.8, 49.7, 49.3, 48.5, 47.6, 46.3, 43.7, 39.3, 34.1,
          29.0, 23.7, 18.4, 14.3, 12.0, 12.8, 16.0, 19.1, 22.4, 25.6, 30.1,
          35.3, 39.9, 44.5, 47.5, 50.9, 54.1, 56.3, 58.1, 59.8, 61.1, 62.1,
          62.8, 63.3, 63.6, 64.0, 64.7, 65.2, 65.3, 65.3, 65.4, 65.7, 66.0,
          65.6, 63.5, 59.7, 54.6, 49.3, 44.9, 42.3, 41.4, 41.3, 42.1, 44.7,
          48.4, 51.4, 52.7, 53.0, 52.5, 51.3, 49.7, 47.4, 43.7, 39.7, 35.5,
          31.1, 26.3, 21.9, 18.0, 17.0, 18.0, 21.4, 24.8, 27.9, 30.8, 33.0,
          35.1, 37.1, 38.9, 41.4, 44.0, 46.3, 47.7, 48.2, 48.7, 49.3, 49.8,
          50.2, 50.9, 51.8, 52.5, 53.3, 54.5, 55.7, 56.5, 56.8, 57.0, 57.2,
          57.7, 58.7, 60.1, 61.1, 61.7, 62.3, 62.9, 63.3, 63.4, 63.5, 64.5,
          65.8, 66.8, 67.4, 68.8, 71.1, 72.3, 72.8, 73.4, 74.6, 76.0, 76.6,
          76.5, 76.2, 75.8, 75.4, 74.8, 73.9, 72.7, 71.3, 70.4, 70.0, 70.0,
          69.0, 68.0, 68.0, 68.0, 68.1, 68.4, 68.6, 68.7, 68.5, 68.1, 67.3,
          66.2, 64.8, 63.6, 62.6, 62.1, 61.9, 61.9, 61.8, 61.5, 60.9, 59.7,
          54.6, 49.3, 44.9, 42.3, 41.4, 41.3, 42.1, 44.7, 48.4, 51.4, 52.7,
          54.0, 57.0, 58.1, 59.2, 59.0, 59.1, 59.5, 60.5, 62.3, 63.9, 65.1,
          64.1, 62.7, 62.0, 61.3, 60.9, 60.5, 60.2, 59.8, 59.4, 58.6, 57.5,
          56.6, 56.0, 55.5, 55.0, 54.4, 54.1, 54.0, 53.9, 53.9, 54.0, 54.2,
          55.0, 55.8, 56.2, 56.1, 55.1, 52.7, 48.4, 43.1, 37.8, 32.5, 27.2,
          25.1, 26.0, 29.3, 34.6, 40.4, 45.3, 49.0, 51.1, 52.1, 52.2, 52.1,
          51.7, 50.9, 49.2, 45.9, 40.6, 35.3, 30.0, 24.7, 19.3, 16.0, 13.2,
          10.7, 8.8, 7.2, 5.5, 3.2, 1.1, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0,
          0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0,
          0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0,
          0.0, 0.0, 0.0, 0.0, 0.0, 0.8, 3.6, 8.6, 14.6, 20.0, 24.4, 28.2, 31.7,
          35.0, 37.6, 39.7, 41.5, 43.6, 46.0, 48.4, 50.5, 51.9, 52.6, 52.8,
          52.9, 53.1, 53.3, 53.1, 52.3, 50.7, 48.8, 46.5, 43.8, 40.3, 36.0,
          30.7, 25.4, 21.0, 16.7, 13.4, 12.0, 12.1, 12.8, 15.6, 19.9, 23.4,
          24.6, 25.2, 26.4, 28.8, 31.8, 35.3, 39.5, 44.5, 49.3, 53.3, 56.4,
          58.9, 61.2, 62.6, 63.0, 62.5, 60.9, 59.3, 58.6, 58.6, 58.7, 58.8,
          58.8, 58.8, 59.1, 60.1, 61.7, 63.0, 63.7, 63.9, 63.5, 62.3, 60.3,
          58.9, 58.4, 58.8, 60.2, 62.3, 63.9, 64.5, 64.4, 63.5, 62.0, 61.2,
          61.3, 62.6, 65.3, 68.0, 69.4, 69.7, 69.3, 68.1, 66.9, 66.2, 65.7,
          64.9, 63.2, 60.3, 55.8, 50.5, 45.2, 40.1, 36.2, 32.9, 29.8, 26.6,
          23.0, 19.4, 16.3, 14.6, 14.2, 14.3, 14.6, 15.1, 16.4, 19.1, 22.5,
          24.4, 24.8, 22.7, 17.4, 13.8, 12.0, 12.0, 12.0, 13.9, 17.7, 22.8,
          27.3, 31.2, 35.2, 39.4, 42.5, 45.4, 48.2, 50.3, 52.6, 54.5, 56.6,
          58.3, 60.0, 61.5, 63.1, 64.3, 65.7, 67.1, 68.3, 69.7, 70.6, 71.6,
          72.6, 73.5, 74.2, 74.9, 75.6, 76.3, 77.1, 77.9, 78.5, 79.0, 79.7,
          80.3, 81.0, 81.6, 82.4, 82.9, 83.4, 83.8, 84.2, 84.7, 85.2, 85.6,
          86.3, 86.8, 87.4, 88.0, 88.3, 88.7, 89.0, 89.3, 89.8, 90.2, 90.6,
          91.0, 91.3, 91.6, 91.9, 92.2, 92.8, 93.1, 93.3, 93.5, 93.7, 93.9,
          94.0, 94.1, 94.3, 94.4, 94.6, 94.7, 94.8, 95.0, 95.1, 95.3, 95.4,
          95.6, 95.7, 95.8, 96.0, 96.1, 96.3, 96.4, 96.6, 96.8, 97.0, 97.2,
          97.3, 97.4, 97.4, 97.4, 97.4, 97.3, 97.3, 97.3, 97.3, 97.2, 97.1,
          97.0, 96.9, 96.7, 96.4, 96.1, 95.7, 95.5, 95.3, 95.2, 95.0, 94.9,
          94.7, 94.5, 94.4, 94.4, 94.3, 94.3, 94.1, 93.9, 93.4, 92.8, 92.0,
          91.3, 90.6, 90.0, 89.3, 88.7, 88.1, 87.4, 86.7, 86.0, 85.3, 84.7,
          84.1, 83.5, 82.9, 82.3, 81.7, 81.1, 80.5, 79.9, 79.4, 79.1, 78.8,
          78.5, 78.2, 77.9, 77.6, 77.3, 77.0, 76.7, 76.0, 76.0, 76.0, 75.9,
          75.9, 75.8, 75.7, 75.5, 75.2, 75.0, 74.7, 74.1, 73.7, 73.3, 73.5,
          74.0, 74.9, 76.1, 77.7, 79.2, 80.3, 80.8, 81.0, 81.0, 81.0, 81.0,
          81.0, 80.9, 80.6, 80.3, 80.0, 79.9, 79.8, 79.8, 79.8, 79.9, 80.0,
          80.4, 80.8, 81.2, 81.5, 81.6, 81.6, 81.4, 80.7, 79.6, 78.2, 76.8,
          75.3, 73.8, 72.1, 70.2, 68.2, 66.1, 63.8, 61.6, 60.2, 59.8, 60.4,
          61.8, 62.6, 62.7, 61.9, 60.0, 58.4, 57.8, 57.8, 57.8, 57.3, 56.2,
          54.3, 50.8, 45.5, 40.2, 34.9, 29.6, 27.3, 29.3, 32.9, 35.6, 36.7,
          37.6, 39.4, 42.5, 46.5, 50.2, 52.8, 54.3, 54.9, 54.9, 54.7, 54.1,
          53.2, 52.1, 50.7, 49.1, 47.4, 45.2, 41.8, 36.5, 31.2, 27.6, 26.9,
          27.3, 27.5, 27.4, 27.1, 26.7, 26.8, 28.2, 31.1, 34.8, 38.4, 40.9,
          41.7, 40.9, 38.3, 35.3, 34.3, 34.6, 36.3, 39.5, 41.8, 42.5, 41.9,
          40.1, 36.6, 31.3, 26.0, 20.6, 19.1, 19.7, 21.1, 22.0, 22.1, 21.4,
          19.6, 18.3, 18.0, 18.3, 18.5, 17.9, 15.0, 9.9, 4.6, 1.2, 0.0, 0.0,
          0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0,
          0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 2.2, 4.4, 6.3,
          7.9, 9.2, 10.4, 11.5, 12.9, 14.7, 17.0, 19.8, 23.1, 26.7, 30.5, 34.1,
          37.5, 40.6, 43.3, 45.7, 47.7, 49.3, 50.5, 51.3, 52.1, 52.7, 53.4,
          54.0, 54.5, 55.0, 55.6, 56.3, 57.2, 58.5, 60.2, 62.3, 64.7, 67.1,
          69.2, 70.7, 71.9, 72.7, 73.4, 73.8, 74.1, 74.0, 73.6, 72.5, 70.8,
          68.6, 66.2, 64.0, 62.2, 60.9, 60.2, 60.0, 60.4, 61.4, 63.2, 65.6,
          68.4, 71.6, 74.9, 78.4, 81.8, 84.9, 87.4, 89.0, 90.0, 90.6, 91.0,
          91.5, 92.0, 92.7, 93.4, 94.2, 94.9, 95.7, 96.6, 97.7, 98.9, 100.4,
          102.0, 103.6, 105.2, 106.8, 108.5, 110.2, 111.9, 113.7, 115.3, 116.8,
          118.2, 119.5, 120.7, 121.8, 122.6, 123.2, 123.6, 123.7, 123.6, 123.3,
          123.0, 122.5, 122.1, 121.5, 120.8, 120.0, 119.1, 118.1, 117.1, 116.2,
          115.5, 114.9, 114.5, 114.1, 113.9, 113.7, 113.3, 112.9, 112.2, 111.4,
          110.5, 109.5, 108.5, 107.7, 107.1, 106.6, 106.4, 106.2, 106.2, 106.2,
          106.4, 106.5, 106.8, 107.2, 107.8, 108.5, 109.4, 110.5, 111.7, 113.0,
          114.1, 115.1, 115.9, 116.5, 116.7, 116.6, 116.2, 115.2, 113.8, 112.0,
          110.1, 108.3, 107.0, 106.1, 105.8, 105.7, 105.7, 105.6, 105.3, 104.9,
          104.4, 104.0, 103.8, 103.9, 104.4, 105.1, 106.1, 107.2, 108.5, 109.9,
          111.3, 112.7, 113.9, 115.0, 116.0, 116.8, 117.6, 118.4, 119.2, 120.0,
          120.8, 121.6, 122.3, 123.1, 123.8, 124.4, 125.0, 125.4, 125.8, 126.1,
          126.4, 126.6, 126.7, 126.8, 126.9, 126.9, 126.9, 126.8, 126.6, 126.3,
          126.0, 125.7, 125.6, 125.6, 125.8, 126.2, 126.6, 127.0, 127.4, 127.6,
          127.8, 127.9, 128.0, 128.1, 128.2, 128.3, 128.4, 128.5, 128.6, 128.6,
          128.5, 128.3, 128.1, 127.9, 127.6, 127.4, 127.2, 127.0, 126.9, 126.8,
          126.7, 126.8, 126.9, 127.1, 127.4, 127.7, 128.1, 128.5, 129.0, 129.5,
          130.1, 130.6, 131.0, 131.2, 131.3, 131.2, 130.7, 129.8, 128.4, 126.5,
          124.1, 121.6, 119.0, 116.5, 114.1, 111.8, 109.5, 107.1, 104.8, 102.5,
          100.4, 98.6, 97.2, 95.9, 94.8, 93.8, 92.8, 91.8, 91.0, 90.2, 89.6,
          89.1, 88.6, 88.1, 87.6, 87.1, 86.6, 86.1, 85.5, 85.0, 84.4, 83.8,
          83.2, 82.6, 82.0, 81.3, 80.4, 79.1, 77.4, 75.1, 72.3, 69.1, 65.9,
          62.7, 59.7, 57.0, 54.6, 52.2, 49.7, 46.8, 43.5, 39.9, 36.4, 33.2,
          30.5, 28.3, 26.3, 24.4, 22.5, 20.5, 18.2, 15.5, 12.3, 8.7, 5.2, 0.0,
          0.0, 0.0, 0.0, 0.0, 0.0,
        ];
        RAW_FTP75_VELOCITIES = [
          0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 4.8,
          9.44, 13.76, 18.4, 22.88, 27.04, 27.68, 28.96, 33.12, 34.72, 35.84,
          36, 35.36, 34.4, 33.44, 32.64, 31.68, 27.2, 23.84, 23.84, 24.32, 24.8,
          25.6, 27.36, 30.56, 33.76, 36.32, 36.64, 36.32, 36.16, 34.08, 30.4,
          27.36, 25.28, 25.28, 28.32, 31.68, 34.56, 37.12, 38.72, 39.36, 39.84,
          40, 39.36, 39.2, 39.52, 39.68, 39.52, 39.36, 39.36, 40.16, 40.96,
          41.12, 40.64, 39.84, 40, 40.64, 41.6, 41.6, 41.12, 41.76, 42.72, 44,
          45.76, 46.88, 47.68, 48.16, 48.64, 49.12, 49.12, 48.8, 48.64, 48.48,
          48.64, 49.28, 48.64, 47.84, 47.2, 47.68, 48.48, 49.12, 49.44, 49.6,
          49.44, 48.64, 47.68, 47.84, 48.32, 49.12, 49.92, 50.88, 51.52, 51.84,
          51.52, 50.72, 45.76, 40.48, 35.2, 29.92, 24.64, 19.36, 14.08, 8.8,
          3.52, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
          0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 5.28, 10.56,
          15.84, 21.12, 26.4, 31.68, 35.52, 38.88, 41.28, 42.24, 41.12, 40.16,
          39.52, 40, 40.32, 40.64, 41.28, 43.52, 42.4, 38.4, 36.32, 31.04,
          28.32, 27.52, 28.96, 29.76, 32, 35.52, 39.2, 43.68, 48.8, 53.6, 57.92,
          59.68, 62.88, 64.8, 67.36, 69.6, 72.16, 73.6, 74.88, 76, 76, 75.68,
          75.52, 75.2, 75.2, 75.2, 75.2, 75.2, 75.52, 75.84, 76.64, 77.6, 78.56,
          79.2, 80, 80.96, 81.6, 82.4, 83.52, 85.12, 86.56, 87.36, 87.84, 88,
          87.84, 87.36, 87.36, 87.68, 88.16, 88.8, 89.12, 89.76, 90.08, 90.56,
          90.72, 90.72, 90.4, 90.4, 90.4, 90.4, 90.4, 90.4, 90.24, 89.76, 89.28,
          88.16, 87.36, 86.72, 86.4, 85.92, 85.76, 86.24, 86.4, 86.56, 86.56,
          86.08, 85.44, 84.8, 84.16, 83.36, 83.84, 83.2, 83.04, 82.72, 82.4,
          82.56, 82.88, 83.36, 84, 84.8, 85.6, 86.4, 87.84, 88.64, 88.96, 89.6,
          89.6, 89.28, 88.32, 87.2, 85.76, 84, 82.4, 82.4, 82.4, 81.76, 80.16,
          80, 80.16, 80, 79.36, 79.2, 79.2, 79.2, 78.56, 77.76, 76.96, 75.52,
          73.76, 72, 70.08, 68.16, 66.4, 64.48, 61.6, 59.2, 56.32, 54.08, 52,
          50.4, 48.96, 48.8, 48, 46.4, 44, 39.68, 34.4, 32.16, 30.56, 29.6,
          27.2, 24.8, 20, 17.28, 12.8, 7.52, 2.24, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
          0, 0, 0, 0, 1.6, 6.88, 12.16, 17.44, 22.72, 27.68, 32, 36, 37.92,
          40.32, 42.56, 44.96, 48, 49.28, 50.56, 51.36, 52.48, 53.76, 55.2,
          55.36, 55.84, 55.68, 55.2, 55.52, 56.8, 57.6, 57.6, 57.6, 57.6, 57.6,
          57.6, 57.76, 58.24, 58.4, 58.24, 57.6, 56.16, 54.56, 53.6, 50.24,
          46.4, 41.12, 36.8, 32.48, 28, 23.2, 19.2, 13.92, 8.64, 3.36, 0, 0, 0,
          0, 0, 0, 4.16, 9.44, 14.72, 20, 25.28, 30.56, 35.84, 40, 40.96, 44,
          46.4, 48, 48.16, 48, 47.52, 46.88, 46.08, 44.8, 40, 34.72, 29.44,
          24.16, 18.88, 13.6, 8.32, 3.04, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
          0, 0, 0, 0, 0, 0, 5.28, 10.56, 15.84, 21.12, 26.4, 31.68, 36.96,
          42.24, 44.48, 46.56, 50.4, 52.8, 53.76, 55.68, 56.16, 56.96, 57.76,
          57.6, 57.76, 57.92, 57.6, 57.12, 57.6, 57.6, 56.96, 56.8, 56.64,
          56.32, 56.32, 56.32, 56.32, 56.32, 56.32, 56, 56.16, 56.32, 56.8,
          56.32, 56, 56, 56, 55.68, 55.36, 55.2, 53.6, 51.2, 48.16, 44.8, 40.8,
          36, 31.68, 26.4, 21.12, 16.48, 11.52, 6.4, 1.6, 0, 0, 0, 0, 0, 0,
          1.92, 5.6, 8.8, 10.4, 13.6, 15.36, 16.8, 19.04, 22.4, 25.6, 28.32,
          30.4, 32.16, 33.6, 35.2, 36.8, 38.08, 39.2, 39.84, 40, 40, 40, 40, 40,
          40, 40.96, 41.28, 41.6, 40.96, 40.32, 40, 40, 40, 39.04, 36.96, 31.68,
          26.4, 21.12, 15.84, 10.56, 5.28, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
          0, 0, 0, 0, 0, 5.28, 10.56, 15.84, 20.8, 23.36, 25.6, 27.2, 27.2,
          27.2, 28, 28.32, 28.32, 28, 27.2, 27.04, 26.56, 27.2, 27.36, 27.2,
          26.56, 26.4, 26.4, 26.56, 27.2, 28.16, 29.6, 30.72, 32.32, 33.6,
          33.76, 33.92, 34.56, 35.2, 35.84, 36, 36, 36, 36.32, 37.92, 40.16,
          41.6, 42.4, 43.2, 41.76, 36.48, 31.2, 25.92, 20.64, 15.36, 10.08, 4.8,
          0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
          0, 0, 0, 3.2, 7.2, 12.48, 16.32, 20, 22.4, 24.48, 28, 31.36, 33.6,
          35.52, 37.28, 39.2, 40.48, 40.96, 41.6, 41.76, 41.92, 41.92, 42.24,
          42.4, 42.4, 41.6, 40.8, 37.76, 34.24, 29.6, 26.24, 23.2, 18.56, 13.92,
          9.28, 5.6, 3.2, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 2.24, 5.28,
          7.04, 10.4, 14.72, 18.08, 21.6, 23.36, 26.24, 26.72, 26.4, 26.4,
          29.12, 30.72, 32.16, 34.4, 36, 36, 35.36, 36.32, 37.28, 37.6, 36,
          34.56, 32.8, 28.8, 24, 19.2, 14.4, 9.92, 7.2, 4.8, 3.36, 0.8, 0.8,
          5.12, 10.4, 15.36, 20, 22.4, 25.6, 28.8, 31.36, 34.4, 36.96, 39.2,
          40.8, 42.4, 43.36, 44.16, 44.64, 45.28, 45.76, 45.76, 45.28, 45.12,
          44.8, 44, 42.88, 40.8, 37.6, 34.4, 30.4, 26.4, 23.84, 20, 15.04, 9.92,
          4.8, 2.4, 2.4, 0.8, 0, 4.8, 10.08, 15.36, 20.64, 25.28, 28, 29.44,
          31.2, 33.12, 35.2, 37.12, 40, 42.4, 44, 44.8, 45.28, 46.24, 46.24,
          46.24, 46.08, 45.6, 45.28, 45.28, 45.28, 45.12, 44.16, 44, 44, 44, 44,
          44, 44, 44.16, 44.8, 45.6, 48, 49.6, 51.2, 52.8, 52.8, 53.76, 54.4,
          54.88, 54.72, 54.4, 54.4, 54.24, 53.76, 52.96, 52.8, 52, 51.2, 51.04,
          50.56, 50.4, 48.96, 48, 47.84, 47.84, 47.84, 47.84, 47.36, 47.2, 47.2,
          46.88, 46.24, 45.12, 44.32, 43.2, 40.8, 37.92, 35.2, 32.8, 30.72,
          30.72, 32.16, 33.44, 34.24, 35.2, 36.16, 37.12, 38.4, 40, 41.6, 42.56,
          42.56, 42.88, 43.2, 43.52, 44.48, 44.96, 46.08, 46.24, 46.4, 46.56,
          46.4, 44.96, 44, 43.2, 41.28, 40, 39.2, 39.68, 40.16, 40.8, 41.12,
          41.92, 43.04, 44, 44.48, 45.44, 46.4, 46.72, 46.56, 46.4, 46.24, 45.6,
          44.96, 44.8, 44.8, 44.16, 43.52, 42.56, 43.2, 44, 44.48, 44.8, 44.48,
          44.8, 44.8, 44.8, 44.32, 43.84, 43.04, 42.56, 42.4, 42.4, 42.4, 42.08,
          41.92, 41.92, 41.44, 40.96, 40.96, 41.44, 41.28, 40.8, 39.36, 37.6,
          35.52, 34.56, 34.56, 34.72, 36.16, 37.44, 38.4, 38.72, 39.04, 39.84,
          40.16, 40.32, 40.48, 40.8, 40.32, 40, 40, 40, 39.52, 39.2, 38.88,
          38.88, 39.2, 40, 40, 39.36, 39.36, 38.56, 39.2, 40.16, 40.96, 40.16,
          38.4, 35.2, 32.16, 27.04, 21.76, 16.48, 11.2, 5.92, 0.64, 0, 0, 0,
          3.2, 8.48, 13.76, 19.04, 24.32, 28, 29.76, 32, 33.76, 35.2, 36.8,
          39.2, 42.08, 44, 44.96, 45.44, 45.6, 45.6, 45.6, 44.32, 44, 43.52,
          42.88, 42.4, 41.6, 41.12, 40.32, 38.4, 35.2, 34.4, 34.4, 34.88, 36,
          36.8, 36.48, 36.48, 36.8, 36.32, 36.32, 36.32, 37.6, 38.4, 39.36,
          39.68, 40.16, 40.8, 40.96, 40.8, 40, 38.56, 37.92, 37.12, 36.64, 36,
          35.2, 34.56, 32.8, 28, 22.72, 17.44, 12.16, 6.88, 1.6, 0, 0, 0, 0, 0,
          0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
          0, 0, 1.92, 6.4, 11.68, 16.96, 22.24, 27.2, 29.6, 32, 34.88, 36.8,
          38.4, 39.68, 40.96, 42.4, 42.88, 43.84, 44.64, 45.28, 44.8, 44, 43.2,
          43.2, 42.08, 39.2, 36, 34.4, 32.96, 28.8, 24, 19.68, 17.76, 16.96, 16,
          15.2, 14.56, 13.92, 13.76, 14.08, 14.4, 13.92, 13.76, 12.8, 11.2, 8,
          6.72, 4.16, 1.6, 0, 0.16, 0.96, 2.56, 5.76, 11.04, 16, 20.48, 22.4,
          23.2, 25.6, 28.96, 32, 33.6, 33.92, 34.08, 34.24, 34.72, 36, 36.8,
          38.08, 39.2, 40, 39.84, 39.68, 40, 40.64, 41.28, 41.6, 42.24, 42.56,
          43.04, 43.2, 43.2, 43.2, 43.04, 42.88, 42.88, 42.4, 42.24, 41.6, 40.8,
          39.36, 37.6, 34.4, 32, 28, 25.6, 22.4, 17.12, 11.84, 6.56, 1.28, 0, 0,
          0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 3.36, 8.64, 13.92, 19.2,
          24.48, 29.76, 33.76, 36.8, 37.6, 36.8, 36, 32, 26.72, 21.44, 16.16,
          10.88, 5.6, 0.32, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0.32, 2.4, 5.6, 10.4,
          15.68, 19.2, 20.64, 20.8, 20.16, 20.48, 20.96, 20.96, 22.4, 24.8,
          27.2, 29.76, 31.52, 33.6, 34.4, 34.88, 34.88, 34.4, 33.92, 34.4,
          34.88, 35.2, 35.04, 34.72, 34.4, 34.4, 34.24, 32.16, 31.2, 30.72,
          31.36, 31.68, 32, 31.2, 28, 24.8, 20.8, 16, 12.8, 9.6, 6.4, 4, 1.12,
          0, 0, 0, 0, 0, 0, 0, 0, 1.6, 1.6, 1.6, 1.6, 1.6, 2.56, 4.8, 6.4, 8,
          10.08, 12.8, 16, 16.8, 15.2, 13.6, 12.16, 14.08, 17.6, 22.4, 27.2,
          31.2, 33.6, 34.88, 35.52, 36.8, 37.76, 38.56, 39.2, 39.2, 38.4, 37.6,
          37.6, 37.6, 37.6, 37.6, 37.6, 38.4, 38.56, 39.2, 39.52, 40, 40.64,
          40.96, 41.12, 41.6, 41.92, 43.2, 44.48, 45.28, 46.4, 46.56, 46.4,
          44.8, 39.52, 34.24, 28.96, 23.68, 18.4, 13.12, 7.84, 2.56, 0, 0, 0, 0,
          0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 2.4,
          7.68, 12.96, 18.24, 21.12, 24.16, 26.88, 29.28, 31.2, 32.48, 34.08,
          35.04, 35.36, 35.84, 35.2, 34.56, 33.76, 32.8, 32, 31.36, 29.6, 28,
          26.4, 24.8, 22.4, 17.6, 12.8, 8.32, 4, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
          0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 4.8, 9.44, 13.76,
          18.4, 22.88, 27.04, 27.68, 28.96, 33.12, 34.72, 35.84, 36, 35.36,
          34.4, 33.44, 32.64, 31.68, 27.2, 23.84, 23.84, 24.32, 24.8, 25.6,
          27.36, 30.56, 33.76, 36.32, 36.64, 36.32, 36.16, 34.08, 30.4, 27.36,
          25.28, 25.28, 28.32, 31.68, 34.56, 37.12, 38.72, 39.36, 39.84, 40,
          39.36, 39.2, 39.52, 39.68, 39.52, 39.36, 39.36, 40.16, 40.96, 41.12,
          40.64, 39.84, 40, 40.64, 41.6, 41.6, 41.12, 41.76, 42.72, 44, 45.76,
          46.88, 47.68, 48.16, 48.64, 49.12, 49.12, 48.8, 48.64, 48.48, 48.64,
          49.28, 48.64, 47.84, 47.2, 47.68, 48.48, 49.12, 49.44, 49.6, 49.44,
          48.64, 47.68, 47.84, 48.32, 49.12, 49.92, 50.88, 51.52, 51.84, 51.52,
          50.72, 45.76, 40.48, 35.2, 29.92, 24.64, 19.36, 14.08, 8.8, 3.52, 0,
          0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
          0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 5.28, 10.56, 15.84,
          21.12, 26.4, 31.68, 35.52, 38.88, 41.28, 42.24, 41.12, 40.16, 39.52,
          40, 40.32, 40.64, 41.28, 43.52, 42.4, 38.4, 36.32, 31.04, 28.32,
          27.52, 28.96, 29.76, 32, 35.52, 39.2, 43.68, 48.8, 53.6, 57.92, 59.68,
          62.88, 64.8, 67.36, 69.6, 72.16, 73.6, 74.88, 76, 76, 75.68, 75.52,
          75.2, 75.2, 75.2, 75.2, 75.2, 75.52, 75.84, 76.64, 77.6, 78.56, 79.2,
          80, 80.96, 81.6, 82.4, 83.52, 85.12, 86.56, 87.36, 87.84, 88, 87.84,
          87.36, 87.36, 87.68, 88.16, 88.8, 89.12, 89.76, 90.08, 90.56, 90.72,
          90.72, 90.4, 90.4, 90.4, 90.4, 90.4, 90.4, 90.24, 89.76, 89.28, 88.16,
          87.36, 86.72, 86.4, 85.92, 85.76, 86.24, 86.4, 86.56, 86.56, 86.08,
          85.44, 84.8, 84.16, 83.36, 83.84, 83.2, 83.04, 82.72, 82.4, 82.56,
          82.88, 83.36, 84, 84.8, 85.6, 86.4, 87.84, 88.64, 88.96, 89.6, 89.6,
          89.28, 88.32, 87.2, 85.76, 84, 82.4, 82.4, 82.4, 81.76, 80.16, 80,
          80.16, 80, 79.36, 79.2, 79.2, 79.2, 78.56, 77.76, 76.96, 75.52, 73.76,
          72, 70.08, 68.16, 66.4, 64.48, 61.6, 59.2, 56.32, 54.08, 52, 50.4,
          48.96, 48.8, 48, 46.4, 44, 39.68, 34.4, 32.16, 30.56, 29.6, 27.2,
          24.8, 20, 17.28, 12.8, 7.52, 2.24, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
          0, 0, 1.6, 6.88, 12.16, 17.44, 22.72, 27.68, 32, 36, 37.92, 40.32,
          42.56, 44.96, 48, 49.28, 50.56, 51.36, 52.48, 53.76, 55.2, 55.36,
          55.84, 55.68, 55.2, 55.52, 56.8, 57.6, 57.6, 57.6, 57.6, 57.6, 57.6,
          57.76, 58.24, 58.4, 58.24, 57.6, 56.16, 54.56, 53.6, 50.24, 46.4,
          41.12, 36.8, 32.48, 28, 23.2, 19.2, 13.92, 8.64, 3.36, 0, 0, 0, 0, 0,
          0, 4.16, 9.44, 14.72, 20, 25.28, 30.56, 35.84, 40, 40.96, 44, 46.4,
          48, 48.16, 48, 47.52, 46.88, 46.08, 44.8, 40, 34.72, 29.44, 24.16,
          18.88, 13.6, 8.32, 3.04, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
          0, 0, 0, 0, 5.28, 10.56, 15.84, 21.12, 26.4, 31.68, 36.96, 42.24,
          44.48, 46.56, 50.4, 52.8, 53.76, 55.68, 56.16, 56.96, 57.76, 57.6,
          57.76, 57.92, 57.6, 57.12, 57.6, 57.6, 56.96, 56.8, 56.64, 56.32,
          56.32, 56.32, 56.32, 56.32, 56.32, 56, 56.16, 56.32, 56.8, 56.32, 56,
          56, 56, 55.68, 55.36, 55.2, 53.6, 51.2, 48.16, 44.8, 40.8, 36, 31.68,
          26.4, 21.12, 16.48, 11.52, 6.4, 1.6, 0,
        ];
        const VEHICLE_PRESETS = {
          tesla_model_3_lr: {
            name: "Tesla Model 3 Highland (RWD)",
            mass: 1828,
            cd: 0.22,
            frontalArea: 2.22,
            wheelRadius: 0.334,
            crr: 0.009,
            gearRatio: 9.0,
            batteryCapacity: 75,
            maxRegenCRate: 1.0,
            motorEff: 92,
            drivetrainEff: 90,
            maxTorque: 450,
            maxPower: 235,
            massFactor: 5,
            efficiency: 90,
          },
          bmw_i4_edrive40: {
            name: "BMW i4 (eDrive40)",
            mass: 2125,
            cd: 0.24,
            frontalArea: 2.31,
            wheelRadius: 0.339,
            crr: 0.009,
            gearRatio: 8.77,
            batteryCapacity: 81.5,
            maxRegenCRate: 1.42,
            motorEff: 92,
            drivetrainEff: 95,
            maxTorque: 430,
            maxPower: 250,
            massFactor: 5,
            efficiency: 93,
          },
          porsche_taycan_rwd: {
            name: "Porsche Taycan (RWD)",
            mass: 2050,
            cd: 0.22,
            frontalArea: 2.33,
            wheelRadius: 0.365,
            crr: 0.009,
            gearRatio: 8.1,
            batteryCapacity: 71,
            maxRegenCRate: 3.73,
            motorEff: 92,
            drivetrainEff: 95,
            maxTorque: 345,
            maxPower: 240,
            massFactor: 5,
            efficiency: 93,
          },
          tesla_model_y_lr: {
            name: "Tesla Model Y (LR)",
            mass: 1979,
            cd: 0.23,
            frontalArea: 2.39,
            wheelRadius: 0.356,
            crr: 0.009,
            gearRatio: 9.0,
            batteryCapacity: 75,
            maxRegenCRate: 1.07,
            motorEff: 92,
            drivetrainEff: 95,
            maxTorque: 527,
            maxPower: 378,
            massFactor: 5,
            efficiency: 93,
          },
          bmw_ix_xdrive50: {
            name: "BMW iX (xDrive50)",
            mass: 2585,
            cd: 0.25,
            frontalArea: 2.82,
            wheelRadius: 0.394,
            crr: 0.009,
            gearRatio: 8.97,
            batteryCapacity: 105.2,
            maxRegenCRate: 1.9,
            motorEff: 92,
            drivetrainEff: 95,
            maxTorque: 765,
            maxPower: 385,
            massFactor: 5,
            efficiency: 93,
          },
        };
        let state = {
          regenConfig: {
            strategy: "simple",
            simplePercent: 50,
            rules: [
              { threshold: 1.5, percent: 75 },
              { threshold: 1.25, percent: 50 },
              { threshold: 0, percent: 100 },
            ],
          },
          tooltipIndex: null,
          currentDriveCycle: "wltp",
          lastResults: null,
          isSimStateDirty: false,
        };

        const DOM = {
          form: document.getElementById("ev-form"),
          modelSelect: document.getElementById("model-select"),
          modelTitle: document.getElementById("model-title"),
          plotCanvasSpeed: document.getElementById("plot-canvas-speed"),
          plotCanvasSecondary: document.getElementById("plot-canvas-secondary"),
          plotSelector: document.getElementById("plot-selector"),
          cycleSelectorContainer: document.getElementById(
            "drive-cycle-selector-container"
          ),
          tabSwitcher: document.querySelector(".tab-switcher"),
          tabPanels: document.querySelectorAll(".tab-panel"),
          paramGroupRange: document.getElementById("param-group-range"),
          paramGroupPerf: document.getElementById("param-group-perf"),
          runRangeBtn: document.getElementById("run-range-btn"),
          runPerfBtn: document.getElementById("run-perf-btn"),
          inputs: {
            mass: document.getElementById("mass"),
            cd: document.getElementById("cd"),
            frontalArea: document.getElementById("frontal-area"),
            wheelRadius: document.getElementById("wheel-radius"),
            crr: document.getElementById("crr"),
            gearRatio: document.getElementById("gear-ratio"),
            batteryCapacity: document.getElementById("battery-capacity"),
            drivetrainEff: document.getElementById("drivetrain-eff"),
            motorEff: document.getElementById("motor-eff"),
            maxRegenCRate: document.getElementById("max-regen-c-rate"),
            maxTorque: document.getElementById("max-torque"),
            maxPower: document.getElementById("max-power"),
            massFactor: document.getElementById("mass-factor"),
            efficiency: document.getElementById("efficiency"),
          },
          summary: {
            time: document.getElementById("summary-time"),
            distance: document.getElementById("summary-distance"),
            energy: document.getElementById("summary-energy"),
            energyPercent: document.getElementById("summary-energy-percent"),
            consumption: document.getElementById("summary-consumption"),
            range: document.getElementById("summary-range"),
            rangeLabel: document.getElementById("summary-range-label"),
          },
          regen: {
            strategySelect: document.getElementById("regen-strategy"),
            configureBtn: document.getElementById("configure-rules-btn"),
            configureContainer: document.getElementById(
              "configure-rules-container"
            ),
            modal: document.getElementById("rules-modal"),
            form: document.getElementById("rules-form"),
            closeBtn: document.getElementById("close-rules-btn"),
            cancelBtn: document.getElementById("cancel-rules-btn"),
            simpleDiv: document.getElementById("modal-simple-rule"),
            ruleBasedDiv: document.getElementById("modal-rule-based-rules"),
            simplePercent: document.getElementById("rule-simple-percent"),
            rules: {
              highDecel: document.getElementById("rule-high-decel"),
              highPercent: document.getElementById("rule-high-percent"),
              medDecel: document.getElementById("rule-med-decel"),
              medPercent: document.getElementById("rule-med-percent"),
              lowPercent: document.getElementById("rule-low-percent"),
            },
          },
          help: {
            modal: document.getElementById("help-modal"),
            triggerBtn: document.getElementById("help-btn"),
            closeBtn: document.getElementById("close-help-btn"),
          },
          perf: {
            panel: document.getElementById("performance-panel"), // **MODIFICATION**
            targetSpeed: document.getElementById("perf-target-speed"),
            accelStart: document.getElementById("perf-accel-start"),
            accelEnd: document.getElementById("perf-accel-end"),
            accelGrade: document.getElementById("perf-accel-grade"),
            maxGradeResult: document.getElementById("max-grade-result-val"),
            accelResultVal: document.getElementById("accel-result-val"),
            accelResultTitle: document.getElementById("accel-result-title"),
            accelResultSlope: document.getElementById("accel-result-slope"),
            maxSpeedTableBody: document.getElementById("max-speed-table-body"),
            motorPlot: document.getElementById("motorPlotContainer"),
            vehiclePlot: document.getElementById("vehiclePlotContainer"),
          },
        };

        // --- 2. CORE FUNCTIONS ---
        const getDriveCycleVelocities = (cycleName) => {
          if (cycleName === "wltp") return RAW_WLTP_VELOCITIES;
          if (cycleName === "ftp75") return RAW_FTP75_VELOCITIES;

          // Default to NEDC
          const v = [];
          for (let i = 0; i < RAW_NEDC_DATA.length - 1; i++) {
            const [tStart, vStart] = RAW_NEDC_DATA[i];
            const [tEnd, vEnd] = RAW_NEDC_DATA[i + 1];
            const dt = tEnd - tStart,
              dv = vEnd - vStart;
            if (dt === 0) continue;
            for (let t = 0; t < dt; t++) {
              v[tStart + t] = vStart + (dv * t) / dt;
            }
          }
          v[RAW_NEDC_DATA[RAW_NEDC_DATA.length - 1][0]] =
            RAW_NEDC_DATA[RAW_NEDC_DATA.length - 1][1];
          for (let i = 1; i < v.length; i++) {
            if (v[i] === undefined) v[i] = v[i - 1];
          }
          return v;
        };
        const runSimulation = (params, velocityProfile, regenConf) => {
          const results = {
            time: [],
            velocity: [],
            tractionForce: [],
            brakingForce: [],
            batteryPower: [],
            motorTorque: [],
            cumulativeEnergy: [],
            acceleration_kmhs: [],
          };
          let cumulativeEnergyKWh = 0,
            cumulativeDistanceM = 0;
          for (let t = 0; t < velocityProfile.length; t++) {
            const v_kmh = velocityProfile[t],
              v_ms = v_kmh / 3.6;
            const prev_v_ms = t > 0 ? velocityProfile[t - 1] / 3.6 : 0;
            const a_ms2 = v_ms - prev_v_ms;
            const f_rr = params.crr * params.mass * PHYSICS.g;
            const f_aero =
              0.5 * PHYSICS.rho * params.cd * params.frontalArea * v_ms ** 2;
            const f_inertia = params.mass * a_ms2;
            const required_force = f_rr + f_aero + f_inertia;
            let tractionForce = 0,
              brakingForce = 0,
              batteryPower_kW = 0,
              motorForce = 0;
            if (required_force >= 0) {
              tractionForce = v_ms === 0 && a_ms2 === 0 ? 0 : required_force;
              motorForce = tractionForce / params.drivetrainEff;
              batteryPower_kW =
                (tractionForce * v_ms) /
                1000 /
                (params.drivetrainEff * params.motorEff);
            } else {
              brakingForce = required_force;
              let regenFactor = 0;
              if (regenConf.strategy === "rule-based") {
                const decel = Math.abs(a_ms2 * 3.6);
                for (const rule of regenConf.rules) {
                  if (decel > rule.threshold) {
                    regenFactor = rule.percent / 100;
                    break;
                  }
                }
              } else if (regenConf.strategy === "simple") {
                regenFactor = regenConf.simplePercent / 100;
              }
              motorForce = (brakingForce * regenFactor) / params.drivetrainEff;
              const potentialBrakingPower_kW =
                Math.abs(brakingForce * v_ms) / 1000;
              const generatedPowerAtBattery_kW =
                potentialBrakingPower_kW *
                regenFactor *
                params.drivetrainEff *
                params.motorEff;
              const maxRegenPower_kW =
                params.maxRegenCRate * params.batteryCapacity;
              batteryPower_kW = -Math.min(
                generatedPowerAtBattery_kW,
                maxRegenPower_kW
              );
            }
            results.time.push(t);
            results.velocity.push(v_kmh);
            results.tractionForce.push(tractionForce);
            results.brakingForce.push(brakingForce);
            results.batteryPower.push(batteryPower_kW);
            results.motorTorque.push(
              (motorForce * params.wheelRadius) / params.gearRatio
            );
            results.acceleration_kmhs.push(a_ms2 * 3.6);
            cumulativeEnergyKWh += batteryPower_kW / 3600;
            results.cumulativeEnergy.push(cumulativeEnergyKWh);
            cumulativeDistanceM += (v_ms + prev_v_ms) / 2;
          }
          const distanceKm = cumulativeDistanceM / 1000;
          const consumption =
            distanceKm > 0 ? (cumulativeEnergyKWh / distanceKm) * 100 : 0;
          const summary = {
            runTimeMin: (velocityProfile.length - 1) / 60,
            distanceKm,
            totalEnergyKwh: cumulativeEnergyKWh,
            consumption,
            energyUsedPercent:
              params.batteryCapacity > 0
                ? (cumulativeEnergyKWh / params.batteryCapacity) * 100
                : 0,
            estimatedRangeKm:
              consumption > 0 && params.batteryCapacity > 0
                ? (params.batteryCapacity * 100) / consumption
                : 0,
          };
          return { results, summary };
        };

        // --- PERFORMANCE CALCULATION FUNCTIONS ---
        function calculateMotorCurves(params) {
          const vehicleSpeedAtMaxRpm = 180;
          const maxRpm =
            (((vehicleSpeedAtMaxRpm / 3.6) * 60) /
              (2 * Math.PI * params.wheelRadius)) *
            params.gearRatio;
          const rpmAxis = Array.from(
            { length: 201 },
            (_, i) => i * (maxRpm / 200)
          );
          const torqueCurve = [];
          const asymptoteCurve = [];
          rpmAxis.forEach((rpm) => {
            const angular_velocity_rad_s = (rpm * (2 * Math.PI)) / 60;
            const power_limited_torque =
              params.maxPower / (angular_velocity_rad_s || 1e-6);
            torqueCurve.push(Math.min(params.maxTorque, power_limited_torque));
            asymptoteCurve.push(
              Math.min(power_limited_torque, params.maxTorque * 2)
            );
          });
          return { rpmAxis, torqueCurve, asymptoteCurve };
        }
        function analyzeGradeability(angle_deg, params) {
          const angle_rad = angle_deg * (Math.PI / 180);
          const speeds_ms = Array.from(
            { length: 201 },
            (_, i) => i * (50 / 200)
          );
          const F_roll =
            params.crr * params.mass * PHYSICS.g * Math.cos(angle_rad);
          const F_grade = params.mass * PHYSICS.g * Math.sin(angle_rad);
          const F_aero = speeds_ms.map(
            (v) => 0.5 * PHYSICS.rho * params.cd * params.frontalArea * v ** 2
          );
          const F_total_resistance = F_aero.map((fa) => F_roll + F_grade + fa);
          const F_torque_limited =
            (params.maxTorque * params.gearRatio * params.efficiency) /
            params.wheelRadius;
          const F_tractive = speeds_ms.map((v) => {
            const F_power_limited =
              (params.maxPower * params.efficiency) / (v || 1e-6);
            return Math.min(F_torque_limited, F_power_limited);
          });
          let intersection = { x: 0, y: 0 };
          for (let i = speeds_ms.length - 1; i >= 0; i--) {
            if (F_tractive[i] >= F_total_resistance[i]) {
              intersection.x = speeds_ms[i];
              intersection.y = F_tractive[i];
              break;
            }
          }
          return {
            speeds_kmh: speeds_ms.map((v) => v * 3.6),
            F_total_resistance,
            F_tractive,
            intersection,
          };
        }
        function calculateMaxGradeAtSpeed(targetSpeed_kmh, params) {
          const speed_ms = targetSpeed_kmh / 3.6;
          const F_torque_limited =
            (params.maxTorque * params.gearRatio * params.efficiency) /
            params.wheelRadius;
          const F_power_limited =
            (params.maxPower * params.efficiency) / (speed_ms || 1e-6);
          const F_tractive = Math.min(F_torque_limited, F_power_limited);
          const F_rolling_flat = params.crr * params.mass * PHYSICS.g;
          const F_aero =
            0.5 * PHYSICS.rho * params.cd * params.frontalArea * speed_ms ** 2;
          const F_available_for_grade = F_tractive - F_rolling_flat - F_aero;
          if (F_available_for_grade <= 0) return 0;
          const sin_theta = F_available_for_grade / (params.mass * PHYSICS.g);
          return Math.asin(Math.min(sin_theta, 1.0)) * (180 / Math.PI);
        }
        function calculateAccelerationTime(
          startSpeed_kmh,
          endSpeed_kmh,
          grade_deg,
          params
        ) {
          if (startSpeed_kmh >= endSpeed_kmh) return 0;
          const start_ms = startSpeed_kmh / 3.6;
          const end_ms = endSpeed_kmh / 3.6;
          const grade_rad = grade_deg * (Math.PI / 180);
          const dt = 0.05;
          let time = 0;
          let current_speed_ms = start_ms;
          const effectiveMass = params.mass * (1 + params.massFactor);
          const F_grade = params.mass * PHYSICS.g * Math.sin(grade_rad);
          while (current_speed_ms < end_ms) {
            const F_torque_limited =
              (params.maxTorque * params.gearRatio * params.efficiency) /
              params.wheelRadius;
            const F_power_limited =
              (params.maxPower * params.efficiency) /
              (current_speed_ms || 1e-6);
            const F_tractive = Math.min(F_torque_limited, F_power_limited);
            const F_rolling =
              params.crr * params.mass * PHYSICS.g * Math.cos(grade_rad);
            const F_aero =
              0.5 *
              PHYSICS.rho *
              params.cd *
              params.frontalArea *
              current_speed_ms ** 2;
            const F_resistance = F_rolling + F_aero + F_grade;
            const F_net = F_tractive - F_resistance;
            if (F_net <= 0) return Infinity;
            const acceleration = F_net / effectiveMass;
            current_speed_ms += acceleration * dt;
            time += dt;
            if (time > 120) return Infinity;
          }
          return time;
        }

        // --- PLOTTING AND RENDERING FUNCTIONS ---
        function plotData(canvas, dataX, datasets, activeIndex, options = {}) {
          const ctx = canvas.getContext("2d"),
            dpr = window.devicePixelRatio || 1;
          const rect = canvas.getBoundingClientRect();
          canvas.width = rect.width * dpr;
          canvas.height = rect.height * dpr;
          ctx.scale(dpr, dpr);
          const { width, height } = rect,
            padding = { top: 20, right: 20, bottom: 40, left: 60 };
          const style = getComputedStyle(document.documentElement);
          const plotBgColor = style.getPropertyValue("--plot-bg").trim();
          const gridColor = style.getPropertyValue("--plot-grid-major").trim();
          const textColor = style.getPropertyValue("--plot-text").trim();
          const colorConsumption = style
            .getPropertyValue("--color-consumption")
            .trim();
          const colorRegen = style.getPropertyValue("--color-regen").trim();
          const tooltipBg = style.getPropertyValue("--plot-tooltip-bg").trim();
          const tooltipText = style
            .getPropertyValue("--plot-tooltip-text")
            .trim();
          ctx.fillStyle = plotBgColor;
          ctx.fillRect(0, 0, width, height);
          let yMin = 0,
            yMax = 0;
          datasets.forEach((ds) => {
            yMin = Math.min(yMin, ...ds.data);
            yMax = Math.max(yMax, ...ds.data);
          });
          if (options.centerAtZero) {
            const absMax = Math.max(Math.abs(yMin), Math.abs(yMax));
            const powerOf10 = Math.pow(10, Math.floor(Math.log10(absMax || 1)));
            yMax = Math.ceil(absMax / powerOf10) * powerOf10;
            yMin = -yMax;
          } else {
            yMin = options.forceMinZero ? 0 : Math.floor(yMin);
            yMax = Math.ceil(yMax) || 10;
          }
          const yRange = yMax - yMin;
          const xMax = Math.max(...dataX);
          const xScale =
            xMax > 0 ? (width - padding.left - padding.right) / xMax : 0;
          const yScale =
            yRange > 0 ? (height - padding.top - padding.bottom) / yRange : 0;
          const getY = (val) => height - padding.bottom - (val - yMin) * yScale;
          ctx.lineWidth = 1;
          ctx.font = "12px sans-serif";
          ctx.strokeStyle = gridColor;
          ctx.fillStyle = textColor;
          const yTickInterval = options.yTickInterval || yRange / 5 || 1;
          for (let val = yMin; val <= yMax; val += yTickInterval) {
            const yPos = getY(val);
            if (yPos >= padding.top && yPos <= height - padding.bottom) {
              ctx.beginPath();
              ctx.moveTo(padding.left, yPos);
              ctx.lineTo(width - padding.right, yPos);
              ctx.stroke();
              ctx.textAlign = "right";
              ctx.textBaseline = "middle";
              ctx.fillText(Math.round(val), padding.left - 8, yPos);
            }
          }
          const xTickInterval = Math.max(
            100,
            Math.round(xMax / 10 / 100) * 100
          );
          for (let t = 0; t <= xMax; t += xTickInterval) {
            const xPos = padding.left + t * xScale;
            ctx.beginPath();
            ctx.moveTo(xPos, padding.top);
            ctx.lineTo(xPos, height - padding.bottom);
            ctx.stroke();
            ctx.textAlign = "center";
            ctx.textBaseline = "top";
            ctx.fillText(t, xPos, height - padding.bottom + 8);
          }
          ctx.save();
          ctx.fillStyle = textColor;
          ctx.font = "bold 12px sans-serif";
          ctx.textAlign = "center";
          ctx.textBaseline = "bottom";
          ctx.fillText("Time (s)", width / 2, height - 5);
          ctx.restore();

          datasets.forEach((ds) => {
            if (ds.options?.areaFill) {
              const yZero = getY(0);
              const consumptionGradient = ctx.createLinearGradient(
                0,
                yZero,
                0,
                padding.top
              );
              consumptionGradient.addColorStop(0, `${colorConsumption}66`);
              consumptionGradient.addColorStop(1, `${colorConsumption}00`);
              ctx.beginPath();
              ctx.moveTo(padding.left, yZero);
              for (let j = 0; j < dataX.length; j++)
                ctx.lineTo(
                  padding.left + dataX[j] * xScale,
                  getY(Math.max(0, ds.data[j]))
                );
              ctx.lineTo(
                padding.left + dataX[dataX.length - 1] * xScale,
                yZero
              );
              ctx.closePath();
              ctx.fillStyle = consumptionGradient;
              ctx.fill();
              const regenGradient = ctx.createLinearGradient(
                0,
                yZero,
                0,
                height - padding.bottom
              );
              regenGradient.addColorStop(0, `${colorRegen}66`);
              regenGradient.addColorStop(1, `${colorRegen}00`);
              ctx.beginPath();
              ctx.moveTo(padding.left, yZero);
              for (let j = 0; j < dataX.length; j++)
                ctx.lineTo(
                  padding.left + dataX[j] * xScale,
                  getY(Math.min(0, ds.data[j]))
                );
              ctx.lineTo(
                padding.left + dataX[dataX.length - 1] * xScale,
                yZero
              );
              ctx.closePath();
              ctx.fillStyle = regenGradient;
              ctx.fill();
            }
            ctx.beginPath();
            ctx.strokeStyle = ds.color;
            ctx.lineWidth = 2;
            ctx.lineJoin = "round";
            ctx.moveTo(padding.left, getY(ds.data[0]));
            for (let j = 1; j < dataX.length; j++)
              ctx.lineTo(padding.left + dataX[j] * xScale, getY(ds.data[j]));
            ctx.stroke();
          });

          const legendX = padding.left + 20;
          datasets.forEach((ds, index) => {
            const legendY = padding.top + 5 + index * 20;
            ctx.fillStyle = ds.color;
            ctx.fillRect(legendX, legendY - 5, 15, 10);
            ctx.fillStyle = textColor;
            ctx.font = "12px sans-serif";
            ctx.textAlign = "left";
            ctx.textBaseline = "middle";
            ctx.fillText(ds.label, legendX + 25, legendY);
          });

          if (
            activeIndex !== null &&
            activeIndex >= 0 &&
            activeIndex < dataX.length
          ) {
            const xPos = padding.left + dataX[activeIndex] * xScale;
            let activeDS = datasets[0];
            let activeVal = activeDS.data[activeIndex];
            if (datasets.length > 1) {
              const nonZero = datasets.find((ds) => ds.data[activeIndex] !== 0);
              if (nonZero) {
                activeDS = nonZero;
                activeVal = nonZero.data[activeIndex];
              }
            }
            const yPos = getY(activeVal);
            ctx.beginPath();
            ctx.strokeStyle = "#888";
            ctx.lineWidth = 1;
            ctx.moveTo(xPos, padding.top);
            ctx.lineTo(xPos, height - padding.bottom);
            ctx.stroke();
            ctx.beginPath();
            ctx.fillStyle = activeDS.color;
            ctx.arc(xPos, yPos, 5, 0, 2 * Math.PI);
            ctx.fill();
            const text1 = `Time: ${dataX[activeIndex].toFixed(0)} s`,
              text2 = `${activeDS.label
                .split("(")[0]
                .trim()}: ${activeVal.toFixed(2)}`;
            const textWidth = Math.max(
              ctx.measureText(text1).width,
              ctx.measureText(text2).width
            );
            let boxX = xPos + 15;
            if (boxX + textWidth + 20 > width) boxX = xPos - textWidth - 25;
            ctx.fillStyle = tooltipBg;
            ctx.fillRect(boxX, yPos - 15, textWidth + 20, 40);
            ctx.fillStyle = tooltipText;
            ctx.textAlign = "left";
            ctx.fillText(text1, boxX + 10, yPos);
            ctx.fillText(text2, boxX + 10, yPos + 15);
          }
        }

        function getPlotlyBaseLayout() {
          return {
            paper_bgcolor: "#ffffff",
            plot_bgcolor: "#f3f4f6",
            font: {
              color: "#525f7f",
              family:
                '-apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif',
            },
            title: {
              font: { color: "#0d6efd" },
              x: 0.05,
              xanchor: "left",
            },
            xaxis: {
              gridcolor: "#e2e8f0",
              zerolinecolor: "#e2e8f0",
              linecolor: "#e2e8f0",
              automargin: true,
              zerolinewidth: 1,
              title: { standoff: 15 },
            },
            yaxis: {
              gridcolor: "#e2e8f0",
              zerolinecolor: "#e2e8f0",
              linecolor: "#e2e8f0",
              automargin: true,
              zerolinewidth: 1,
              title: { standoff: 20 },
            },
            hovermode: "x unified",
            hoverlabel: {
              bgcolor: "rgba(44, 53, 61, 0.8)",
              font: { color: "#ffffff" },
            },
            legend: {
              orientation: "h",
              yanchor: "bottom",
              y: 1.02,
              xanchor: "right",
              x: 1,
              bgcolor: "rgba(255,255,255,0.0)",
            },
            margin: { t: 60, b: 60, l: 80, r: 30 },
          };
        }

        function renderMotorPlot(rpm, torque, asymptote, params) {
          const cornerRpm =
            (params.maxPower * 60) / (params.maxTorque * 2 * Math.PI);
          const traces = [
            {
              x: rpm,
              y: torque,
              mode: "lines",
              name: "Actual Motor Torque",
              line: { color: "#17becf", width: 3 },
            },
            {
              x: rpm,
              y: asymptote,
              mode: "lines",
              name: "Power Limit Asymptote",
              line: { color: "skyblue", width: 2, dash: "dash" },
            },
          ];

          const baseLayout = getPlotlyBaseLayout();
          const layout = {
            ...baseLayout,
            title: {
              ...baseLayout.title,
              text: "<b>Motor Torque vs. Speed Curve</b>",
            },
            xaxis: {
              ...baseLayout.xaxis,
              title: { ...baseLayout.xaxis.title, text: "Motor Speed (RPM)" },
            },
            yaxis: {
              ...baseLayout.yaxis,
              title: { ...baseLayout.yaxis.title, text: "Motor Torque (Nm)" },
              range: [0, params.maxTorque * 1.5],
            },
            annotations: [
              {
                x: cornerRpm,
                y: params.maxTorque,
                text: `<b>Rated Power (${(params.maxPower / 1000).toFixed(
                  0
                )} kW) <br> at ${cornerRpm.toFixed(0)} RPM</b>`,
                showarrow: true,
                arrowhead: 2,
                arrowcolor: "#dc3545",
                ax: 60,
                ay: -40,
                font: { color: "#ffffff" },
                align: "center",
                bordercolor: "#dc3545",
                borderwidth: 2,
                borderpad: 4,
                bgcolor: "#dc3545",
                opacity: 0.9,
              },
            ],
          };
          Plotly.newPlot(DOM.perf.motorPlot, traces, layout, {
            responsive: true,
          });
        }

        function renderVehiclePlot(traces, yMax, xMax) {
          const baseLayout = getPlotlyBaseLayout();
          const layout = {
            ...baseLayout,
            title: {
              ...baseLayout.title,
              text: "<b>Vehicle Tractive Force vs. Velocity</b>",
            },
            xaxis: {
              ...baseLayout.xaxis,
              title: { ...baseLayout.xaxis.title, text: "Velocity (km/h)" },
              range: [0, xMax * 1.05],
            },
            yaxis: {
              ...baseLayout.yaxis,
              title: { ...baseLayout.yaxis.title, text: "Force (N)" },
              range: [0, yMax * 1.1],
            },
          };
          Plotly.newPlot(DOM.perf.vehiclePlot, traces, layout, {
            responsive: true,
          });
        }

        function updateMaxSpeedTable(results) {
          DOM.perf.maxSpeedTableBody.innerHTML = "";
          results.forEach((res) => {
            const row = `<tr><td>${res.grade}°</td><td>${res.maxSpeed.toFixed(
              1
            )}</td></tr>`;
            DOM.perf.maxSpeedTableBody.innerHTML += row;
          });
        }
        function updateMaxGradeResult(grade, speed) {
          DOM.perf.maxGradeResult.innerHTML = `${grade.toFixed(
            1
          )}° at ${speed} km/h`;
        }
        function updateAccelResult(time, start, end, grade) {
          DOM.perf.accelResultTitle.innerHTML = `Time to accelerate from <strong>${start}</strong> to <strong>${end}</strong> km/h:`;
          if (time === Infinity) {
            DOM.perf.accelResultVal.innerHTML = `<span class="error">Not Possible</span>`;
            DOM.perf.accelResultSlope.innerHTML = `Cannot reach <strong>${end}</strong> km/h under these conditions.`;
          } else {
            DOM.perf.accelResultVal.textContent = `${time.toFixed(2)} s`;
            DOM.perf.accelResultSlope.innerHTML = `on a <strong>${grade}°</strong> slope.`;
          }
        }

        function updateRunButtonState(isDirty) {
          state.isSimStateDirty = isDirty;
          const rangeBtn = DOM.runRangeBtn;
          const perfBtn = DOM.runPerfBtn;
          const btn = !rangeBtn.classList.contains("hidden")
            ? rangeBtn
            : perfBtn;

          btn.classList.remove("warning", "done", "secondary");

          if (isDirty) {
            btn.textContent = "Re-run to Update";
            btn.classList.add("warning");
          } else {
            const type = btn === rangeBtn ? "Range" : "Performance";
            btn.textContent = `${type} Evaluation: Done`;
            btn.classList.add("done");
          }
        }

        // --- MASTER SIMULATION FUNCTIONS ---
        const runRangeAndRender = (forceRecalculate = false) => {
          if (forceRecalculate) {
            state.lastResults = null;
            state.tooltipIndex = null;
          }
          if (!state.lastResults) {
            const params = {
              mass: parseFloat(DOM.inputs.mass.value),
              crr: parseFloat(DOM.inputs.crr.value),
              cd: parseFloat(DOM.inputs.cd.value),
              frontalArea: parseFloat(DOM.inputs.frontalArea.value),
              wheelRadius: parseFloat(DOM.inputs.wheelRadius.value),
              gearRatio: parseFloat(DOM.inputs.gearRatio.value),
              batteryCapacity: parseFloat(DOM.inputs.batteryCapacity.value),
              maxRegenCRate: parseFloat(DOM.inputs.maxRegenCRate.value),
              drivetrainEff: parseFloat(DOM.inputs.drivetrainEff.value) / 100,
              motorEff: parseFloat(DOM.inputs.motorEff.value) / 100,
            };
            const velocityProfile = getDriveCycleVelocities(
              state.currentDriveCycle
            );
            state.regenConfig.strategy = DOM.regen.strategySelect.value;
            state.lastResults = runSimulation(
              params,
              velocityProfile,
              state.regenConfig
            );
          }
          // After calculation (or if using old data), render the plots.
          renderRangePlots();
          // ONLY after a full run, set the button state to clean.
          updateRunButtonState(false);
        };

        function renderRangePlots() {
          if (!state.lastResults) return; // Don't render if there's no data

          const { results, summary } = state.lastResults;
          DOM.summary.time.textContent = `${summary.runTimeMin.toFixed(1)} min`;
          DOM.summary.distance.textContent = `${summary.distanceKm.toFixed(
            2
          )} km`;
          DOM.summary.energy.textContent = `${summary.totalEnergyKwh.toFixed(
            3
          )} kWh`;
          DOM.summary.consumption.textContent = `${summary.consumption.toFixed(
            2
          )} kWh/100km`;
          DOM.summary.energyPercent.textContent = `${summary.energyUsedPercent.toFixed(
            1
          )} %`;
          DOM.summary.rangeLabel.textContent = `Est. Range (${state.currentDriveCycle.toUpperCase()})`;
          DOM.summary.range.textContent = `${summary.estimatedRangeKm.toFixed(
            0
          )} km`;
          plotData(
            DOM.plotCanvasSpeed,
            results.time,
            [
              {
                data: results.velocity,
                label: "Speed (km/h)",
                color: "#0d6efd",
              },
            ],
            state.tooltipIndex,
            { yTickInterval: 25, forceMinZero: true }
          );
          const plotType = DOM.plotSelector.value;
          const plotInfo = {
            acceleration: {
              datasets: [
                {
                  data: results.acceleration_kmhs,
                  label: "Accel. (km/h/s)",
                  color: "#ff7f0e",
                },
              ],
              options: { centerAtZero: true, yTickInterval: 1 },
            },
            wheelForce: {
              datasets: [
                {
                  data: results.tractionForce,
                  label: "Traction Force (N)",
                  color: "#2ca02c",
                },
                {
                  data: results.brakingForce,
                  label: "Braking Force (N)",
                  color: "#f1a55f",
                },
              ],
              options: { centerAtZero: true },
            },
            motorTorque: {
              datasets: [
                {
                  data: results.motorTorque,
                  label: "Motor Torque (Nm)",
                  color: "#17becf",
                },
              ],
              options: { centerAtZero: true },
            },
            batteryPower: {
              datasets: [
                {
                  data: results.batteryPower,
                  label: "Battery Power (kW)",
                  color: "#2ca02c",
                  options: { areaFill: true },
                },
              ],
              options: { centerAtZero: true },
            },
            cumulativeEnergy: {
              datasets: [
                {
                  data: results.cumulativeEnergy,
                  label: "Cumulative Energy (kWh)",
                  color: "#9467bd",
                },
              ],
              options: { forceMinZero: true },
            },
          };
          plotData(
            DOM.plotCanvasSecondary,
            results.time,
            plotInfo[plotType].datasets,
            state.tooltipIndex,
            plotInfo[plotType].options
          );
        }
        const runPerformanceSimulation = () => {
          const params = {
            mass: parseFloat(DOM.inputs.mass.value),
            maxTorque: parseFloat(DOM.inputs.maxTorque.value),
            maxPower: parseFloat(DOM.inputs.maxPower.value) * 1000,
            wheelRadius: parseFloat(DOM.inputs.wheelRadius.value),
            gearRatio: parseFloat(DOM.inputs.gearRatio.value),
            efficiency: parseFloat(DOM.inputs.efficiency.value) / 100,
            cd: parseFloat(DOM.inputs.cd.value),
            frontalArea: parseFloat(DOM.inputs.frontalArea.value),
            crr: parseFloat(DOM.inputs.crr.value),
            massFactor: parseFloat(DOM.inputs.massFactor.value) / 100,
          };

          const gradesToAnalyze = [0, 5, 10, 15, 20, 25];
          let vehiclePlotTraces = [];
          let tableResults = [];
          let intersectionPoints = { x: [], y: [], text: [] };

          gradesToAnalyze.forEach((grade) => {
            const result = analyzeGradeability(grade, params);
            vehiclePlotTraces.push({
              x: result.speeds_kmh,
              y: result.F_total_resistance,
              mode: "lines",
              name: `Slope ${grade}°`,
            });
            tableResults.push({
              grade: grade,
              maxSpeed: result.intersection.x * 3.6,
            });
            if (result.intersection.x > 0) {
              intersectionPoints.x.push(result.intersection.x * 3.6);
              intersectionPoints.y.push(result.intersection.y);
              intersectionPoints.text.push(
                `${(result.intersection.x * 3.6).toFixed(1)}`
              );
            }
          });
          const tractiveForceResult = analyzeGradeability(0, params);
          vehiclePlotTraces.push({
            x: tractiveForceResult.speeds_kmh,
            y: tractiveForceResult.F_tractive,
            mode: "lines",
            name: "Max Tractive Force",
            line: { color: "#2ca02c", width: 3, dash: "dash" },
          });
          vehiclePlotTraces.push({
            x: intersectionPoints.x,
            y: intersectionPoints.y,
            text: intersectionPoints.text,
            hoverinfo: "text",
            mode: "markers",
            name: "Max Speed Points",
            marker: {
              color: "red",
              size: 10,
              symbol: "circle-open",
              line: { width: 2 },
            },
          });

          const motorCurves = calculateMotorCurves(params);

          const targetSpeed = parseFloat(DOM.perf.targetSpeed.value);
          const maxGrade = calculateMaxGradeAtSpeed(targetSpeed, params);
          const accelStart = parseFloat(DOM.perf.accelStart.value);
          const accelEnd = parseFloat(DOM.perf.accelEnd.value);
          const accelGrade = parseFloat(DOM.perf.accelGrade.value);
          const accelTime = calculateAccelerationTime(
            accelStart,
            accelEnd,
            accelGrade,
            params
          );

          renderMotorPlot(
            motorCurves.rpmAxis,
            motorCurves.torqueCurve,
            motorCurves.asymptoteCurve,
            params
          );
          renderVehiclePlot(
            vehiclePlotTraces,
            Math.max(...tractiveForceResult.F_tractive),
            Math.max(...tractiveForceResult.speeds_kmh)
          );
          updateMaxSpeedTable(tableResults);
          updateMaxGradeResult(maxGrade, targetSpeed);
          updateAccelResult(accelTime, accelStart, accelEnd, accelGrade);
          updateRunButtonState(false);
        };

        // --- EVENT LISTENERS & INITIALIZATION ---
        DOM.tabSwitcher.addEventListener("click", (e) => {
          const button = e.target.closest(".tab-btn");
          if (!button) return;
          const targetPanelId = button.dataset.tab;

          if (button.classList.contains("active")) return;

          DOM.tabSwitcher.querySelector(".active")?.classList.remove("active");
          button.classList.add("active");
          DOM.tabPanels.forEach((panel) => {
            panel.classList.toggle("active", panel.id === targetPanelId);
          });
          const isRangeTab = targetPanelId === "range-panel";
          DOM.paramGroupRange.classList.toggle("hidden", !isRangeTab);
          DOM.paramGroupPerf.classList.toggle("hidden", isRangeTab);
          DOM.runRangeBtn.classList.toggle("hidden", !isRangeTab);
          DOM.runPerfBtn.classList.toggle("hidden", isRangeTab);

          if (isRangeTab) {
            runRangeAndRender(true);
          } else {
            runPerformanceSimulation();
          }
        });

        DOM.form.addEventListener("submit", (e) => {
          e.preventDefault();
          if (!DOM.runRangeBtn.classList.contains("hidden")) {
            runRangeAndRender(true);
          } else if (!DOM.runPerfBtn.classList.contains("hidden")) {
            runPerformanceSimulation();
          }
        });

        DOM.form.addEventListener("input", (e) => {
          if (e.target.id !== "model-select") {
            if (DOM.modelSelect.value !== "custom") {
              DOM.modelSelect.value = "custom";
              DOM.modelTitle.textContent = "Custom Model";
            }
            updateRunButtonState(true);
          }
        });

        // **MODIFICATION: Added listener for performance panel inputs**
        DOM.perf.panel.addEventListener("input", () => {
          updateRunButtonState(true);
        });

        DOM.modelSelect.addEventListener("change", (e) => {
          const modelKey = e.target.value;
          if (modelKey === "custom") {
            DOM.modelTitle.textContent = "Custom Model";
            updateRunButtonState(true);
            return;
          }
          const preset = VEHICLE_PRESETS[modelKey];
          if (!preset) return;

          DOM.modelTitle.textContent = preset.name;
          Object.keys(preset).forEach((key) => {
            const id = key.replace(/([A-Z])/g, "-$1").toLowerCase();
            const inputEl = document.getElementById(id);
            if (inputEl) {
              inputEl.value = preset[key];
            }
          });

          document
            .querySelectorAll('input[type="range"]')
            .forEach((slider) => slider.dispatchEvent(new Event("input")));

          const isRangeTabActive =
            !DOM.runRangeBtn.classList.contains("hidden");
          if (isRangeTabActive) {
            runRangeAndRender(true);
          } else {
            runPerformanceSimulation();
          }
        });

        DOM.plotSelector.addEventListener("change", () => renderRangePlots());
        [DOM.plotCanvasSpeed, DOM.plotCanvasSecondary].forEach((canvas) => {
          canvas.addEventListener("mousemove", (e) => {
            if (!state.lastResults) return;
            const rect = canvas.getBoundingClientRect();
            const mouseX = e.clientX - rect.left;
            const padding = { left: 60, right: 20 };
            const xMax = Math.max(...state.lastResults.results.time);
            const xScale =
              xMax > 0 ? (rect.width - padding.left - padding.right) / xMax : 0;
            let timeIndex = Math.round((mouseX - padding.left) / xScale);
            state.tooltipIndex = Math.max(
              0,
              Math.min(state.lastResults.results.time.length - 1, timeIndex)
            );
            renderRangePlots();
          });
          canvas.addEventListener("mouseleave", () => {
            state.tooltipIndex = null;
            renderRangePlots();
          });
        });

        DOM.cycleSelectorContainer.addEventListener("click", (e) => {
          const button = e.target.closest(".cycle-btn");
          if (
            button &&
            button.dataset.cycle &&
            state.currentDriveCycle !== button.dataset.cycle
          ) {
            state.currentDriveCycle = button.dataset.cycle;
            DOM.cycleSelectorContainer
              .querySelector(".active")
              ?.classList.remove("active");
            button.classList.add("active");
            runRangeAndRender(true);
          }
        });

        document.querySelectorAll('input[type="range"]').forEach((slider) => {
          const output = document.getElementById(`${slider.id}-value`);
          if (output) {
            slider.addEventListener("input", () => {
              const unit = output.dataset.unit || "";
              const value = slider.id.includes("capacity")
                ? parseFloat(slider.value).toFixed(1)
                : slider.value;
              output.textContent = `${value}${unit}`;
            });
          }
        });

        const setupModal = (modalEl, triggerBtn, closeBtn) => {
          const open = () => (modalEl.style.display = "flex");
          const close = () => (modalEl.style.display = "none");
          triggerBtn.addEventListener("click", open);
          closeBtn.addEventListener("click", close);
          window.addEventListener("click", (e) => {
            if (e.target === modalEl) close();
          });
          return close;
        };
        const closeRulesModal = setupModal(
          DOM.regen.modal,
          DOM.regen.configureBtn,
          DOM.regen.closeBtn
        );
        setupModal(DOM.help.modal, DOM.help.triggerBtn, DOM.help.closeBtn);
        DOM.regen.cancelBtn.addEventListener("click", closeRulesModal);
        DOM.regen.strategySelect.addEventListener("change", () => {
          DOM.regen.configureContainer.style.display =
            DOM.regen.strategySelect.value !== "none" ? "block" : "none";
        });

        DOM.regen.configureBtn.addEventListener("click", () => {
          const strategy = DOM.regen.strategySelect.value;
          const isSimple = strategy === "simple";
          DOM.regen.simpleDiv.style.display = isSimple ? "block" : "none";
          DOM.regen.ruleBasedDiv.style.display = !isSimple ? "block" : "none";
          if (isSimple) {
            DOM.regen.simplePercent.value = state.regenConfig.simplePercent;
          } else {
            DOM.regen.rules.highDecel.value =
              state.regenConfig.rules[0].threshold;
            DOM.regen.rules.highPercent.value =
              state.regenConfig.rules[0].percent;
            DOM.regen.rules.medDecel.value =
              state.regenConfig.rules[1].threshold;
            DOM.regen.rules.medPercent.value =
              state.regenConfig.rules[1].percent;
            DOM.regen.rules.lowPercent.value =
              state.regenConfig.rules[2].percent;
          }
        });

        DOM.regen.form.addEventListener("submit", (e) => {
          e.preventDefault();
          e.stopPropagation(); // <-- Add this line
          if (DOM.regen.strategySelect.value === "simple") {
            state.regenConfig.simplePercent = parseFloat(
              DOM.regen.simplePercent.value
            );
          } else {
            state.regenConfig.rules = [
              {
                threshold: parseFloat(DOM.regen.rules.highDecel.value),
                percent: parseFloat(DOM.regen.rules.highPercent.value),
              },
              {
                threshold: parseFloat(DOM.regen.rules.medDecel.value),
                percent: parseFloat(DOM.regen.rules.medPercent.value),
              },
              {
                threshold: 0,
                percent: parseFloat(DOM.regen.rules.lowPercent.value),
              },
            ].sort((a, b) => b.threshold - a.threshold);
          }

          // Add this line to signal a change has occurred
          updateRunButtonState(true);

          closeRulesModal();
        });

        const initPerfTab = () => {
          DOM.perf.maxSpeedTableBody.innerHTML = "";
          [0, 5, 10, 15, 20, 25].forEach((grade) => {
            const row = `<tr><td>${grade}°</td><td>-</td></tr>`;
            DOM.perf.maxSpeedTableBody.innerHTML += row;
          });
        };

        // --- Initial Page Load ---
        document
          .getElementById(`${state.currentDriveCycle}-btn`)
          .classList.add("active");
        DOM.regen.configureContainer.style.display =
          DOM.regen.strategySelect.value !== "none" ? "block" : "none";
        runRangeAndRender(true);
        initPerfTab();
      });
    </script>
  </body>
</html>
